clear all;
close all;

set(0,'defaultaxeslinewidth',3);
set(0,'defaultaxesfontsize',16);
set(0,'defaulttextfontsize',16);
disp('---------------');

%%
for jjj=1:2
    if jjj==1   %control data
        days=[-3 -1 1 3 5 10 15];
        diffdays=days(2:end);
        
        %------------------- mouse 97 -------------------
        sex{1}=0; %female
        surgery{1}=61; %postnatal age on surgery day
        age{1}=116; %postnatal age on first imaging day
        imageduration{1}=104; %minutes from first to last image files
        
        %spine density = #/length, per um
        density{1}=[.34 .31 .28 NaN NaN NaN NaN; ...
            .47 .38 .35 NaN NaN NaN NaN; ...
            .42 .40 .33 NaN NaN NaN NaN; ...
            .36 .40 .38 NaN NaN NaN NaN];
        
        %dendritic length, um
        lengths{1}=[180.98 180.98 180.98 NaN NaN NaN NaN; ...
            126.13 126.13 126.13 NaN NaN NaN NaN; ...
            164.34 164.34 164.34 NaN NaN NaN NaN; ...
            60.58 60.58 60.58 NaN NaN NaN NaN];
        
        %spine count
        count{1}=[61 56 51 NaN NaN NaN NaN; ...
            59 48 44 NaN NaN NaN NaN; ...
            69 66 55 NaN NaN NaN NaN; ...
            22 24 23 NaN NaN NaN NaN];
        
        %spine formation rate, new spines/total spines in %
        formation{1}=[11.5 10.7 NaN NaN NaN NaN; ...
            1.7 14.6 NaN NaN NaN NaN; ...
            7.2 7.6 NaN NaN NaN NaN; ...
            22.7 16.7 NaN NaN NaN NaN];
        
        %spine elimination rate, eliminated spines/total spines in %
        elim{1}=[19.7 19.6 NaN NaN NaN NaN; ...
            20.3 22.9 NaN NaN NaN NaN; ...
            11.6 24.2 NaN NaN NaN NaN; ...
            13.6 20.8 NaN NaN NaN NaN];
        
        %days where there are visible damage of area, to be excluded
        damagedd{1}=zeros(size(density{1}));
        
        %------------------- mouse 107 -------------------
        sex{2}=0; %female
        surgery{2}=71; %postnatal age on surgery day        
        age{2}=126; %postnatal age on first imaging day
        imageduration{2}=76; %minutes from first to last image files
        
        density{2}=[.35 .32 .32 NaN NaN NaN NaN; ...
            .42 .39 .39 NaN NaN NaN NaN; ...
            .35 .23 .25 NaN NaN NaN NaN; ...
            .45 .35 .31 NaN NaN NaN NaN; ...
            .44 .34 .37 NaN NaN NaN NaN; ...
            .41 .41 .32 NaN NaN NaN NaN; ...
            NaN .46 .40 NaN NaN NaN NaN];
        
        lengths{2}=[195.94 195.94 195.94 NaN NaN NaN NaN; ...
            248.27 248.27 248.27 NaN NaN NaN NaN; ...
            170.08 170.08 170.08 NaN NaN NaN NaN; ...
            48.95 48.95 48.95 NaN NaN NaN NaN; ...
            171.7 171.7 171.7 NaN NaN NaN NaN; ...
            128.14 128.14 128.14 NaN NaN NaN NaN; ...
            NaN 85.54 85.54 NaN NaN NaN NaN];
        
        count{2}=[69 63 63 NaN NaN NaN NaN; ...
            105 96 96 NaN NaN NaN NaN; ...
            60 39 43 NaN NaN NaN NaN; ...
            22 17 15 NaN NaN NaN NaN; ...
            76 59 63 NaN NaN NaN NaN; ...
            53 53 41 NaN NaN NaN NaN; ...
            NaN 39 34 NaN NaN NaN NaN];
        
        formation{2}=[13 17.5 NaN NaN NaN NaN; ...
            9.5 20.8 NaN NaN NaN NaN; ...
            6.7 33.3 NaN NaN NaN NaN; ...
            13.6 11.8 NaN NaN NaN NaN; ...
            10.5 28.8 NaN NaN NaN NaN; ...
            22.6 9.4 NaN NaN NaN NaN; ...
            NaN 12.8 NaN NaN NaN NaN];
        
        elim{2}=[21.7 17.5 NaN NaN NaN NaN; ...
            16.2 20.8 NaN NaN NaN NaN; ...
            41.7 23.1 NaN NaN NaN NaN; ...
            36.4 23.5 NaN NaN NaN NaN; ...
            32.9 22.0 NaN NaN NaN NaN; ...
            22.6 32.1 NaN NaN NaN NaN; ...
            NaN 25.6 NaN NaN NaN NaN];
        
        damagedd{2}=zeros(size(density{2}));
        
        %------------------- mouse 89 -------------------
        sex{3}=1; %male
        surgery{3}=55; %postnatal age on surgery day
        age{3}=128; %postnatal age on first imaging day
        imageduration{3}=37; %minutes from first to last image files
        
        density{3}=[.19 .20 .16 NaN NaN NaN NaN; ...
            .34 .18 .22 NaN NaN NaN NaN; ...
            .22 .23 .21 NaN NaN NaN NaN; ...
            .26 .24 .21 NaN NaN NaN NaN; ...
            .25 .22 .20 NaN NaN NaN NaN; ...
            .27 .23 .21 NaN NaN NaN NaN; ...
            .27 .20 .22 NaN NaN NaN NaN; ...
            .30 .26 .25 NaN NaN NaN NaN; ...
            .39 .36 .31 NaN NaN NaN NaN; ...
            .25 .18 .14 NaN NaN NaN NaN; ...
            .26 .20 .21 NaN NaN NaN NaN; ...
            .27 .22 .18 NaN NaN NaN NaN; ...
            .30 .17 .13 NaN NaN NaN NaN; ...
            NaN .36 .29 NaN NaN NaN NaN];
        
        lengths{3}=[241.81 204.42 204.42 NaN NaN NaN NaN; ...
            139.42 77.04 77.04 NaN NaN NaN NaN; ...
            242.09 242.09 242.09 NaN NaN NaN NaN; ...
            220.5 220.5 220.5 NaN NaN NaN NaN; ...
            194.25 194.25 194.25 NaN NaN NaN NaN; ...
            175.58 175.58 175.58 NaN NaN NaN NaN; ...
            59.67 59.67 59.67 NaN NaN NaN NaN; ...
            79.32 79.32 79.32 NaN NaN NaN NaN; ...
            146.2 146.2 146.2 NaN NaN NaN NaN; ...
            79.62 79.62 79.62 NaN NaN NaN NaN; ...
            91.3 91.3 91.3 NaN NaN NaN NaN; ...
            177.08 177.08 177.08 NaN NaN NaN NaN; ...
            63.37 63.37 63.37 NaN NaN NaN NaN; ...
            NaN 194.73 194.73 NaN NaN NaN NaN];
        
        count{3}=[46 40 33 NaN NaN NaN NaN; ...
            48 14 17 NaN NaN NaN NaN; ...
            53 55 52 NaN NaN NaN NaN; ...
            58 52 46 NaN NaN NaN NaN; ...
            49 42 39 NaN NaN NaN NaN; ...
            47 41 37 NaN NaN NaN NaN; ...
            16 12 13 NaN NaN NaN NaN; ...
            24 21 20 NaN NaN NaN NaN; ...
            57 53 45 NaN NaN NaN NaN; ...
            20 14 11 NaN NaN NaN NaN; ...
            24 18 19 NaN NaN NaN NaN; ...
            48 39 32 NaN NaN NaN NaN; ...
            19 11 8 NaN NaN NaN NaN; ...
            NaN 70 57 NaN NaN NaN NaN];
        
        formation{3}=[21.7 7.5 NaN NaN NaN NaN; ...
            0 28.6 NaN NaN NaN NaN; ...
            28.3 16.4 NaN NaN NaN NaN; ...
            10.3 11.5 NaN NaN NaN NaN; ...
            14.3 9.5 NaN NaN NaN NaN; ...
            12.8 9.8 NaN NaN NaN NaN; ...
            0 33.3 NaN NaN NaN NaN; ...
            12.5 14.3 NaN NaN NaN NaN; ...
            10.5 13.2 NaN NaN NaN NaN; ...
            5.0 7.1 NaN NaN NaN NaN; ...
            12.5 38.9 NaN NaN NaN NaN; ...
            16.7 12.8 NaN NaN NaN NaN; ...
            10.5 9.1 NaN NaN NaN NaN; ...
            NaN 11.4 NaN NaN NaN NaN];
        
        elim{3}=[19.6 25.0 NaN NaN NaN NaN; ...
            27.1 7.1 NaN NaN NaN NaN; ...
            24.5 21.8 NaN NaN NaN NaN; ...
            20.7 23.1 NaN NaN NaN NaN; ...
            28.6 16.7 NaN NaN NaN NaN; ...
            25.5 19.5 NaN NaN NaN NaN; ...
            25.0 25.0 NaN NaN NaN NaN; ...
            25.0 19.0 NaN NaN NaN NaN; ...
            17.5 28.3 NaN NaN NaN NaN; ...
            35.0 28.6 NaN NaN NaN NaN; ...
            37.5 33.3 NaN NaN NaN NaN; ...
            35.4 30.8 NaN NaN NaN NaN; ...
            52.6 36.4 NaN NaN NaN NaN; ...
            NaN 30.0 NaN NaN NaN NaN];
        
        damagedd{3}=zeros(size(density{3}));
        
        %------------------- mouse 134 -------------------
        sex{4}=1; %male
        surgery{4}=123; %postnatal age on surgery day
        age{4}=143; %postnatal age on first imaging day
        imageduration{4}=93; %minutes from first to last image files
        
        density{4}=[.45 .42 .40 NaN NaN NaN NaN; ...
            .27 .24 .29 NaN NaN NaN NaN; ...
            .29 .25 .32 NaN NaN NaN NaN; ...
            .30 .27 .27 NaN NaN NaN NaN; ...
            .25 .25 .23 NaN NaN NaN NaN; ...
            .32 .27 .22 NaN NaN NaN NaN; ...
            .26 .24 .26 NaN NaN NaN NaN; ...
            .28 .25 .24 NaN NaN NaN NaN; ...
            .27 .26 .25 NaN NaN NaN NaN; ...
            .19 .20 .20 NaN NaN NaN NaN; ...
            .30 .31 .30 NaN NaN NaN NaN; ...
            .27 .27 .26 NaN NaN NaN NaN; ...
            .24 .28 .29 NaN NaN NaN NaN; ...
            .27 .33 .28 NaN NaN NaN NaN; ...
            .39 .38 .32 NaN NaN NaN NaN];
        
        lengths{4}=[69.63 69.63 69.63 NaN NaN NaN NaN; ...
            197.54 197.54 197.54 NaN NaN NaN NaN; ...
            68.62 68.62 68.62 NaN NaN NaN NaN; ...
            212.72 212.72 212.72 NaN NaN NaN NaN; ...
            197.50 197.50 197.50 NaN NaN NaN NaN; ...
            116.31 116.31 116.31 NaN NaN NaN NaN; ...
            65.77 65.77 65.77 NaN NaN NaN NaN; ...
            201.55 201.55 201.55 NaN NaN NaN NaN; ...
            127.75 127.75 127.75 NaN NaN NaN NaN; ...
            129.34 129.34 129.34 NaN NaN NaN NaN; ...
            83.55 83.55 83.55 NaN NaN NaN NaN; ...
            190.72 190.72 190.72 NaN NaN NaN NaN; ...
            119.74 119.74 119.74 NaN NaN NaN NaN; ...
            166.09 166.09 166.09 NaN NaN NaN NaN; ...
            161.75 161.75 161.75 NaN NaN NaN NaN];
        
        count{4}=[31 29 28 NaN NaN NaN NaN; ...
            53 47 57 NaN NaN NaN NaN; ...
            20 17 22 NaN NaN NaN NaN; ...
            63 58 57 NaN NaN NaN NaN; ...
            50 49 45 NaN NaN NaN NaN; ...
            37 31 25 NaN NaN NaN NaN; ...
            17 16 17 NaN NaN NaN NaN; ...
            57 50 49 NaN NaN NaN NaN; ...
            35 33 32 NaN NaN NaN NaN; ...
            24 27 27 NaN NaN NaN NaN; ...
            25 26 25 NaN NaN NaN NaN; ...
            51 51 49 NaN NaN NaN NaN; ...
            29 33 35 NaN NaN NaN NaN; ...
            44 55 46 NaN NaN NaN NaN; ...
            63 62 52 NaN NaN NaN NaN];
        
        formation{4}=[9.7 10.3 NaN NaN NaN NaN; ...
            22.6 40.4 NaN NaN NaN NaN; ...
            10 29.4 NaN NaN NaN NaN; ...
            7.9 13.8 NaN NaN NaN NaN; ...
            14 18.4 NaN NaN NaN NaN; ...
            16.2 16.1 NaN NaN NaN NaN; ...
            5.90 18.8 NaN NaN NaN NaN; ...
            15.8 18 NaN NaN NaN NaN; ...
            8.6 9.1 NaN NaN NaN NaN; ...
            16.7 11.1 NaN NaN NaN NaN; ...
            12.00 23.10 NaN NaN NaN NaN; ...
            19.6 23.5 NaN NaN NaN NaN; ...
            13.8 12.1 NaN NaN NaN NaN; ...
            36.4 5.5 NaN NaN NaN NaN; ...
            15.9 3.2 NaN NaN NaN NaN];
        
        elim{4}=[16.2 13.8 NaN NaN NaN NaN; ...
            34 19.2 NaN NaN NaN NaN; ...
            25 0 NaN NaN NaN NaN; ...
            15.9 15.5 NaN NaN NaN NaN; ...
            16 26.5 NaN NaN NaN NaN; ...
            32.4 35.5 NaN NaN NaN NaN; ...
            11.8 12.5 NaN NaN NaN NaN; ...
            28.1 20 NaN NaN NaN NaN; ...
            14.3 12.1 NaN NaN NaN NaN; ...
            4.2 11.1 NaN NaN NaN NaN; ...
            8 26.9 NaN NaN NaN NaN; ...
            19.6 27.5 NaN NaN NaN NaN; ...
            0 6.1 NaN NaN NaN NaN; ...
            11.4 21.8 NaN NaN NaN NaN; ...
            17.5 19.4 NaN NaN NaN NaN];
        
        damagedd{4}=zeros(size(density{4}));
        
        %------------------- mouse 143 -------------------
        sex{5}=1; %male
        surgery{5}=98; %postnatal age on surgery day
        age{5}=122; %postnatal age on first imaging day
        imageduration{5}=100; %minutes from first to last image files
        
        density{5}=[.27 .29 .28 NaN NaN NaN NaN; ...
            .31 .3 .26 NaN NaN NaN NaN; ...
            .28 .3 .25 NaN NaN NaN NaN; ...
            .24 .23 .25 NaN NaN NaN NaN; ...
            .23 .17 .23 NaN NaN NaN NaN; ...
            .24 .23 .19 NaN NaN NaN NaN; ...
            .27 .29 .25 NaN NaN NaN NaN; ...
            .29 .32 .32 NaN NaN NaN NaN; ...
            .39 .44 .41 NaN NaN NaN NaN; ...
            .25 .20 .18 NaN NaN NaN NaN; ...
            .30 .33 .32 NaN NaN NaN NaN; ...
            .34 .27 .26 NaN NaN NaN NaN; ...
            .26 .24 .20 NaN NaN NaN NaN; ...
            .30 .26 .29 NaN NaN NaN NaN; ...
            .24 .2 .17 NaN NaN NaN NaN; ...
            .31 .28 .28 NaN NaN NaN NaN; ...
            .28 .29 .26 NaN NaN NaN NaN];
        
        lengths{5}=[110.61 110.61 110.61 NaN NaN NaN NaN; ...
            150.17 150.17 150.17 NaN NaN NaN NaN; ...
            120.11 120.11 120.11 NaN NaN NaN NaN; ...
            160.05 160.05 160.05 NaN NaN NaN NaN; ...
            69.03 69.03 69.03 NaN NaN NaN NaN; ...
            179.11 179.11 179.11 NaN NaN NaN NaN; ...
            140.52 140.52 140.52 NaN NaN NaN NaN; ...
            99.47 99.47 99.47 NaN NaN NaN NaN; ...
            56.60 56.60 56.60 NaN NaN NaN NaN; ...
            147.6 147.67 147.67 NaN NaN NaN NaN; ...
            235.49 235.49 235.49 NaN NaN NaN NaN; ...
            127.47 127.47 127.47 NaN NaN NaN NaN; ...
            92.21 92.21 92.21 NaN NaN NaN NaN; ...
            156.97 156.97 156.97 NaN NaN NaN NaN; ...
            115.12 115.12 115.12 NaN NaN NaN NaN; ...
            71.13 71.13 71.13 NaN NaN NaN NaN; ...
            81.54 81.54 81.54 NaN NaN NaN NaN];
        
        count{5}=[30 32 31 NaN NaN NaN NaN; ...
            46 45 39 NaN NaN NaN NaN; ...
            34 36 30 NaN NaN NaN NaN; ...
            39 37 40 NaN NaN NaN NaN; ...
            16 12 16 NaN NaN NaN NaN; ...
            43 41 34 NaN NaN NaN NaN; ...
            38 41 35 NaN NaN NaN NaN; ...
            29 32 32 NaN NaN NaN NaN; ...
            22 25 23 NaN NaN NaN NaN; ...
            37 30 26 NaN NaN NaN NaN; ...
            71 77 76 NaN NaN NaN NaN; ...
            43 34 33 NaN NaN NaN NaN; ...
            24 22 18 NaN NaN NaN NaN; ...
            47 40 45 NaN NaN NaN NaN; ...
            27 23 20 NaN NaN NaN NaN; ...
            22 20 20 NaN NaN NaN NaN; ...
            23 24 21 NaN NaN NaN NaN];
        
        formation{5}=[20 15.6 NaN NaN NaN NaN; ...
            17.4 4.4 NaN NaN NaN NaN; ...
            20.6 16.7 NaN NaN NaN NaN; ...
            15.4 18.9 NaN NaN NaN NaN; ...
            0 50 NaN NaN NaN NaN; ...
            16.3 2.4 NaN NaN NaN NaN; ...
            21.0 14.6 NaN NaN NaN NaN; ...
            20.7 12.5 NaN NaN NaN NaN; ...
            18.2 12 NaN NaN NaN NaN; ...
            10.8 13.3 NaN NaN NaN NaN; ...
            22.5 13 NaN NaN NaN NaN; ...
            2.3 8.8 NaN NaN NaN NaN; ...
            16.7 9.1 NaN NaN NaN NaN; ...
            8.5 17.5 NaN NaN NaN NaN; ...
            3.7 0 NaN NaN NaN NaN; ...
            9.1 10 NaN NaN NaN NaN; ...
            8.7 0 NaN NaN NaN NaN];
        
        elim{5}=[13.3 18.8 NaN NaN NaN NaN; ...
            19.6 17.8 NaN NaN NaN NaN; ...
            14.7 33.3 NaN NaN NaN NaN; ...
            20.5 10.8 NaN NaN NaN NaN; ...
            25 16.7 NaN NaN NaN NaN; ...
            20.9 19.5 NaN NaN NaN NaN; ...
            13.2 29.3 NaN NaN NaN NaN; ...
            10.3 12.5 NaN NaN NaN NaN; ...
            4.5 20 NaN NaN NaN NaN; ...
            29.7 26.7 NaN NaN NaN NaN; ...
            14.1 14.3 NaN NaN NaN NaN; ...
            23.3 11.8 NaN NaN NaN NaN; ...
            25 27.3 NaN NaN NaN NaN; ...
            23.4 5 NaN NaN NaN NaN; ...
            18.5 13 NaN NaN NaN NaN; ...
            18.2 10 NaN NaN NaN NaN; ...
            4.4 12.5 NaN NaN NaN NaN];
        
        damagedd{5}=zeros(size(density{5}));
        
        %------------------- mouse 141 -------------------
        sex{6}=1; %male
        surgery{6}=101; %postnatal age on surgery day
        age{6}=129; %postnatal age on first imaging day
        imageduration{6}=91; %minutes from first to last image files
        
        density{6}=[.39 .27 .28 NaN NaN NaN NaN; ...
            .35 .32 .32 NaN NaN NaN NaN; ...
            .36 .26 .29 NaN NaN NaN NaN; ...
            .33 .31 .28 NaN NaN NaN NaN; ...
            .29 .25 .28 NaN NaN NaN NaN; ...
            .35 .31 .28 NaN NaN NaN NaN; ...
            .31 .29 .25 NaN NaN NaN NaN; ...
            .36 .26 .26 NaN NaN NaN NaN; ...
            .33 .29 .37 NaN NaN NaN NaN; ...
            .37 .26 .25 NaN NaN NaN NaN; ...
            .42 .35 .39 NaN NaN NaN NaN; ...
            .32 .22 .26 NaN NaN NaN NaN; ...
            .29 .23 .22 NaN NaN NaN NaN; ...
            .37 .31 .32 NaN NaN NaN NaN; ...
            .31 .21 .21 NaN NaN NaN NaN];
        
        lengths{6}=[120.00 120.00 120.00 NaN NaN NaN NaN; ...
            108.56 108.56 108.56 NaN NaN NaN NaN; ...
            266.34 266.34 266.34 NaN NaN NaN NaN; ...
            112.98 112.98 112.98 NaN NaN NaN NaN; ...
            157.78 157.78 157.78 NaN NaN NaN NaN; ...
            130.17 130.17 130.17 NaN NaN NaN NaN; ...
            189.13 189.13 189.13 NaN NaN NaN NaN; ...
            150.88 150.88 150.88 NaN NaN NaN NaN; ...
            118.67 118.67 118.67 NaN NaN NaN NaN; ...
            121.51 121.51 121.51 NaN NaN NaN NaN; ...
            138.66 138.66 138.66 NaN NaN NaN NaN; ...
            184.15 184.15 184.15 NaN NaN NaN NaN; ...
            107.84 107.84 107.84 NaN NaN NaN NaN; ...
            65.51 65.51 65.51 NaN NaN NaN NaN; ...
            120.21 120.21 120.21 NaN NaN NaN NaN];
        
        count{6}=[47 32 34 NaN NaN NaN NaN; ...
            38 35 35 NaN NaN NaN NaN; ...
            95 70 76 NaN NaN NaN NaN; ...
            37 35 32 NaN NaN NaN NaN; ...
            45 40 44 NaN NaN NaN NaN; ...
            46 40 37 NaN NaN NaN NaN; ...
            58 54 47 NaN NaN NaN NaN; ...
            54 39 39 NaN NaN NaN NaN; ...
            39 34 44 NaN NaN NaN NaN; ...
            45 31 30 NaN NaN NaN NaN; ...
            58 48 54 NaN NaN NaN NaN; ...
            59 41 48 NaN NaN NaN NaN; ...
            31 25 24 NaN NaN NaN NaN; ...
            24 20 21 NaN NaN NaN NaN; ...
            37 25 25 NaN NaN NaN NaN];
        
        formation{6}=[6.4 15.6 NaN NaN NaN NaN; ...
            18.4 11.4 NaN NaN NaN NaN; ...
            8.4 14.3 NaN NaN NaN NaN; ...
            16.2 8.6 NaN NaN NaN NaN; ...
            11.1 17.5 NaN NaN NaN NaN; ...
            10.9 12.5 NaN NaN NaN NaN; ...
            10.3 3.7 NaN NaN NaN NaN; ...
            1.9 10.3 NaN NaN NaN NaN; ...
            7.7 32.4 NaN NaN NaN NaN; ...
            4.4 12.9 NaN NaN NaN NaN; ...
            6.9 22.9 NaN NaN NaN NaN; ...
            5.1 29.3 NaN NaN NaN NaN; ...
            3.2 12.0 NaN NaN NaN NaN; ...
            8.3 20.0 NaN NaN NaN NaN; ...
            2.7 16.0 NaN NaN NaN NaN];
        
        elim{6}=[38.3 9.4 NaN NaN NaN NaN; ...
            26.3 11.4 NaN NaN NaN NaN; ...
            34.7 5.7 NaN NaN NaN NaN; ...
            21.6 17.1 NaN NaN NaN NaN; ...
            22.2 7.5 NaN NaN NaN NaN; ...
            23.9 20.0 NaN NaN NaN NaN; ...
            17.2 16.7 NaN NaN NaN NaN; ...
            29.6 10.3 NaN NaN NaN NaN; ...
            20.5 2.9 NaN NaN NaN NaN; ...
            35.6 16.1 NaN NaN NaN NaN; ...
            24.1 10.4 NaN NaN NaN NaN; ...
            35.6 12.2 NaN NaN NaN NaN; ...
            22.6 16.0 NaN NaN NaN NaN; ...
            25.0 15.0 NaN NaN NaN NaN; ...
            35.1 16.0 NaN NaN NaN NaN];
        
        damagedd{6}=zeros(size(density{6}));
        
        %------------------- mouse 180 -------------------
        sex{7}=1; %male
        surgery{7}=58; %postnatal age on surgery day
        age{7}=98; %postnatal age on first imaging day
        imageduration{7}=122; %minutes from first to last image files
        
        density{7}=[.41 .24 .22 .21 .19 .22 .21; ...
            .31 .26 .24 .30 .28 .29 .31; ...
            .47 .34 .29 .31 .25 .31 .28; ...
            .46 .34 NaN .25 .24 .24 .25; ...
            .28 .24 .26 .26 .25 .30 .26; ...
            .31 .26 .23 .20 .18 NaN .15; ...
            .36 .33 .30 .32 .24 .23 .28; ...
            .33 .26 .28 .27 .23 .24 .23; ...
            .31 .26 .23 .24 .23 .24 .23; ...
            .30 .30 .26 .26 .27 .21 .25; ...
            .29 .26 .23 .25 .25 .24 .26; ...
            .27 .28 .25 .27 .30 .30 .32; ...
            .25 .28 .28 .27 .28 .25 .29; ...
            .33 .35 .31 .36 .35 .32 .33];
        
        lengths{7}=[58.07 58.07 58.07 58.07 58.07 58.07 58.07; ...
            118.79 118.79 118.79 118.79 118.79 118.79 118.79; ...
            68.60 68.60 68.60 68.60 68.60 68.60 68.60; ...
            66.96 66.96 66.96 66.96 66.96 66.96 66.96; ...
            93.03 93.03 93.03 93.03 93.03 93.03 93.03 ; ...
            179.41 179.41 179.41 179.41 179.41 179.41 179.41; ...
            118.88 118.88 118.88 118.88 118.88 118.88 118.88; ...
            70.45 70.45 70.45 70.45 70.45 70.45 70.45; ...
            179.84 179.84 179.84 179.84 179.84 179.84 179.84; ...
            158.27 158.27 158.27 158.27 158.27 158.27 158.27; ...
            185.17 185.17 185.17 185.17 185.17 185.17 185.17; ...
            168.71 168.71 168.71 168.71 168.71 168.71 168.71; ...
            78.83 78.83 78.83 78.83 78.83 78.83 78.83; ...
            71.89 71.89 71.89 71.89 71.89 71.89 71.89];
        
        count{7}=[24 14 13 12 11 13 12; ...
            37 31 29 36 33 34 37; ...
            32 23 20 21 17 21 19; ...
            31 23 NaN 17 16 16 17; ...
            26 22 24 24 23 28 24; ...
            56 47 42 35 33 NaN 27; ...
            43 39 36 38 28 27 33; ...
            23 18 20 19 16 17 16; ...
            56 46 42 44 42 44 41; ...
            48 48 41 41 43 34 39; ...
            53 49 43 46 46 45 48; ...
            46 48 43 45 50 51 54; ...
            20 22 22 21 22 20 23; ...
            24 25 22 26 25 23 24];
        
        formation{7}=[8.3 21.4 7.7 8.3 27.3 7.7; ...
            10.8 3.2 34.5 8.3 12.1 20.6; ...
            3.1 4.3 10.0 0.0 23.5 19.1; ...
            9.7 NaN 0.0 5.9 25.0 25.0; ...
            7.7 22.7 8.3 12.5 30.4 3.6; ...
            12.5 8.5 7.1 14.3 NaN 18.2; ...
            7.0 7.7 16.7 2.6 10.7 44.4; ...
            4.3 27.8 15.0 15.8 25.0 17.7; ...
            7.1 13.0 16.7 6.8 23.8 27.3; ...
            20.8 12.5 14.6 22.0 11.6 38.2; ...
            5.7 8.2 14.0 13.0 10.9 15.6; ...
            21.7 8.3 18.6 22.2 12.0 19.6; ...
            25.0 13.6 9.1 23.8 13.6 25.0; ...
            15.0 12.0 27.3 15.4 8.0 17.4];
        
        elim{7}=[50.0 28.6 15.4 16.7 9.1 15.4; ...
            27.0 9.7 10.3 16.7 9.1 11.8; ...
            31.3 17.4 5.0 19.1 0.0 28.6; ...
            35.5 NaN 26.1 11.8 25.0 18.8; ...
            23.1 13.6 8.3 16.7 8.7 17.9; ...
            28.6 19.2 23.8 20.0 NaN 36.4; ...
            16.3 15.4 11.1 29.0 14.3 22.2; ...
            26.1 16.7 20.0 31.6 18.8 23.5; ...
            25.0 21.7 11.9 11.4 19.1 34.1; ...
            20.8 27.1 14.6 17.1 32.6 23.5; ...
            13.2 20.4 7.0 13.0 13.0 8.9; ...
            17.4 18.8 14.0 11.1 10.0 7.8; ...
            15.0 13.6 13.6 19.1 22.7 10.0; ...
            20.8 24.0 9.1 19.2 16.0 13.0];
        
        damagedd{7}=zeros(size(density{7}));
        
        %------------------- mouse 1 -------------------
        sex{8}=1; %male
        surgery{8}=98; %postnatal age on surgery day
        age{8}=121; %postnatal age on first imaging day
        imageduration{8}=84; %minutes from first to last image files
        
        density{8}=[.28 .29 .28 .30 .24 .24 NaN; ...
            .29 .27 .24 .27 .24 .23 NaN; ...
            .35 .26 .25 .22 .20 .21 NaN; ...
            .30 .41 .31 .31 .26 .27 NaN; ...
            .38 .41 .31 .31 .26 .27 NaN; ...
            NaN .48 .42 .39 .34 .34 NaN; ...
            NaN .33 .33 .27 .24 NaN NaN; ...
            .49 .39 .33 .29 .24 NaN NaN; ...
            NaN .36 .36 .32 .33 .09 NaN; ...
            .36 .36 .30 .26 .30 .26 NaN; ...
            NaN .29 .25 .25 .22 .17 NaN];
        
        lengths{8}=[79.71 79.71 79.71 79.71 79.71 79.71 NaN; ...
            150.02 150.02 150.02 150.02 150.02 150.02 NaN; ...
            107.66 107.66 107.66 107.66 107.66 107.66 NaN; ...
            92.01 92.01 92.01 92.01 92.01 92.01 NaN; ...
            117.82 117.82 117.82 117.82 117.82 117.82 NaN; ...
            NaN 104.91 104.91 104.91 104.91 104.91 NaN; ...
            NaN 66.84 66.84 66.84 66.84 NaN NaN; ...
            156.05 156.05 156.05 156.05 156.05 NaN NaN; ...
            NaN 86.89 86.89 86.89 86.89 86.89 NaN; ...
            95.14 95.14 95.14 95.14 95.14 95.14 NaN; ...
            NaN 157.34 157.34 157.34 157.34 157.34 NaN];
        
        count{8}=[22 23 22 24 19 19 NaN; ...
            43 41 36 40 36 34 NaN; ...
            38 28 27 24 21 23 NaN; ...
            28 39 33 36 32 36 NaN; ...
            45 48 37 37 31 32 NaN; ...
            NaN 50 44 41 36 36 NaN; ...
            NaN 22 22 18 16 NaN NaN; ...
            77 61 51 46 38 NaN NaN; ...
            NaN 31 31 28 29 8 NaN; ...
            34 34 29 25 29 25 NaN; ...
            NaN 45 40 39 35 26 NaN];
        
        formation{8}=[22.7 17.4 27.3 4.2 21.1 NaN; ...
            16.3 7.3 16.7 2.5 13.9 NaN; ...
            7.9 7.1 7.4 8.3 28.6 NaN; ...
            39.3 5.1 12.1 11.1 21.9 NaN; ...
            20.0 0 13.5 10.8 22.6 NaN; ...
            NaN 8.0 2.3 2.4 11.1 NaN; ...
            NaN 13.6 4.5 11.1 NaN NaN; ...
            6.5 11.5 9.8 4.3 NaN NaN; ...
            NaN 12.9 6.5 17.9 6.9 NaN; ...
            26.5 8.8 10.3 28.0 17.2 NaN; ...
            NaN 11.1 7.5 12.8 5.7 NaN];
        
        elim{8}=[18.2 21.7 18.2 25.0 21.1 NaN; ...
            20.9 19.5 5.6 12.5 19.4 NaN; ...
            34.2 10.7 18.5 20.8 19.4 NaN; ...
            0.0 20.5 3.0 22.2 9.4 NaN; ...
            13.3 22.9 13.5 27.0 19.4 NaN; ...
            NaN 20.0 9.1 14.6 11.1 NaN; ...
            NaN 13.6 22.7 22.2 NaN NaN; ...
            27.3 27.9 19.6 21.7 NaN NaN; ...
            NaN 12.9 16.1 14.3 79.3 NaN; ...
            26.5 23.5 24.1 12.0 31.0 NaN; ...
            NaN 22.2 10.0 23.1 31.4 NaN];
        
        damagedd{8}=zeros(size(density{8}));
        
    elseif jjj==2   %ketamine data
        days=[-3 -1 1 3 5 10 15];
        diffdays=days(2:end);
        
        %------------------- mouse 28 -------------------
        sex{1}=0; %female
        surgery{1}=103; %postnatal age on surgery day
        age{1}=118; %postnatal age on first imaging day
        imageduration{1}=144; %minutes from first to last image files
        
        density{1}=[0.11 0.13 0.1 0.1 NaN 0.14 0.11; ...
            0.16 NaN 0.21 0.17 NaN 0.17 0.21; ...
            0.16 0.19 0.18 0.19 NaN 0.21 0.16; ...
            0.16 0.13 0.18 0.13 NaN 0.21 0.18; ...
            0.15 0.13 0.15 NaN NaN 0.22 0.15; ...
            0.19 0.21 0.2 0.2 NaN 0.19 0.16; ...
            0.25 0.21 0.23 0.21 NaN 0.22 0.23];
        
        %dendritic length
        lengths{1}=[247.6 247.6 247.6 247.6 NaN 247.6 247.6; ...
            269.1 NaN 269.1 269.1 NaN 269.1 269.1; ...
            177.8 177.8 177.8 177.8 NaN 177.8 177.8; ...
            61.5 61.5 61.5 61.5 NaN 61.5 61.5; ...
            330.5 330.5 330.5 NaN NaN 330.5 330.5; ...
            113.0 113.0 113.0 113.0 NaN 113.0 113.0; ...
            222.1 222.1 222.1 222.1 NaN 222.1 222.1];
        
        %spine count
        count{1}=[26 32 25 25 NaN 34 28; ...
            43 NaN 45 48 NaN 48 57; ...
            29 33 32 33 NaN 38 30; ...
            10 8 11 8 NaN 13 11; ...
            48 31 41 NaN NaN 72 50; ...
            22 24 23 23 NaN 22 18; ...
            55 47 50 46 NaN 48 50];
        
        %spine formation rate
        formation{1}=[38.5 12.5 24 NaN 52 17.6; ...
            NaN 32.6 15.6 NaN 25 25; ...
            27.6 21.2 18.8 NaN 27.3 18.4; ...
            0 37.5 18.2 NaN 75 15.4; ...
            18.8 29 NaN NaN 83.3 16.7; ...
            18.2 8.3 8.7 NaN 26.1 9.1; ...
            7.3 21.3 14 NaN 32.6 20.8];
        
        %spine elimination rate
        elim{1}=[19.2 34.4 24 NaN 16 35.3; ...
            NaN 18.6 24.4 NaN 25 22.9; ...
            13.8 18.2 15.6 NaN 12.1 39.5; ...
            20 0 45.5 NaN 12.5 30.8; ...
            27.1 16.1 NaN NaN 31 31.9; ...
            9.1 4.2 8.7 NaN 21.7 27.3; ...
            21.8 14.9 22 NaN 13.9 18.8];
        
        damagedd{1}=zeros(size(density{1}));
        
        %------------------- mouse 86 -------------------
        sex{2}=1; %male
        surgery{2}=54; %postnatal age on surgery day
        age{2}=73; %postnatal age on first imaging day
        imageduration{2}=94; %minutes from first to last image files
        
        density{2}=[0.15 0.13 0.15 0.22 0.23 0.15 0.11; ...
            0.21 0.17 0.17 0.15 0.15 0.08 0.09; ...
            0.14 0.14 0.15 0.13 0.17 NaN 0.16; ...
            0.30 0.35 0.30 NaN NaN NaN 0.20; ...
            0.22 0.17 0.13 0.10 0.12 0.11 NaN; ...
            0.17 0.10 0.16 0.06 0.06 0.08 0.09; ...
            NaN 0.09 0.15 0.14 0.15 0.18 0.17; ...
            NaN NaN 0.15 0.14 0.15 0.10 NaN; ...
            NaN NaN NaN 0.17 0.19 0.19 0.17; ...
            NaN NaN NaN 0.23 0.20 0.18 0.16];
        
        lengths{2}=[123.5 123.5 123.5 123.5 123.5 123.5 123.5; ...
            138.6 138.6 89.2 89.2 89.2 89.2 76.0; ...
            160.9 160.9 109.4 109.4 NaN NaN NaN; ... %blobs destroyed
            100.0 40.5 NaN NaN NaN NaN NaN; ... %blob appear on day 3
            193.8 155.6 155.6 NaN NaN NaN NaN; ... %blob appear day 4
            82.9 82.9 82.9 82.9 82.9 NaN NaN; ... %tiny tiny blob appear day 4. large blobs appear day 6
            NaN 128.5 128.5 128.5 128.5 128.5 128.5; ...
            NaN NaN 150.2 150.2 NaN NaN NaN; ... %blob appear day 5
            NaN NaN NaN 51.9 51.9 NaN NaN; ... %blob appear day 6
            NaN NaN NaN 211.8 211.8 211.8 211.8];
        
        count{2}=[19 16 18 27 28 19 4; ...
            29 23 15 13 13 7 7; ...
            22 23 14 7 9 NaN 11; ...
            12 14 12 NaN NaN NaN 8; ...
            34 26 20 16 18 17 NaN; ...
            14 8 13 3 3 4 5; ...
            NaN 11 19 18 19 23 22; ...
            NaN NaN 23 21 22 15 NaN; ...
            NaN NaN NaN 9 10 10 9; ...
            NaN NaN NaN 48 43 39 34];
        
        formation{2}=[21.1 43.8 66.7 14.8 17.9 10.5; ...
            13.8 13.0 33.3 30.8 15.4 85.7; ...
            31.8 9.1 50.0 71.4 NaN NaN; ...
            41.7 21.4 NaN NaN NaN 33.3; ...
            26.5 34.6 35 62.5 50.0 NaN; ...
            14.3 75.0 33.3 33.3 66.7 75.0; ...
            NaN 109.1 15.8 50.0 52.6 43.5; ...
            NaN NaN 26.1 19.0 36.4 NaN; ...
            NaN NaN NaN 55.6 40.0 50; ...
            NaN NaN NaN 14.6 23.3 17.9];
        
        elim{2}=[31.6 31.3 27.8 11.1 32.1 36.8; ...
            34.5 17.4 46.7 30.8 61.5 85.7; ...
            22.7 36.4 33.3 42.9 NaN NaN; ...
            25.0 35.7 NaN NaN NaN 50.0; ...
            50.0 53.8 55.0 50.0 55.6 NaN; ...
            57.1 12.5 33.3 0.0 66.7 50.0; ...
            NaN 36.4 21.1 44.4 31.6 47.8; ...
            NaN NaN 34.8 14.3 22.7 NaN; ...
            NaN NaN NaN 44.4 40.0 60.0; ...
            NaN NaN NaN 25.0 32.6 30.8];
        
        damagedd{2}=[0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 1 0 0; ...
            0 0 1 0 0 0 1; ...
            0 0 0 1 1 1 0; ...
            0 0 0 0 0 1 1; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 1 1 0; ...
            0 0 0 0 0 1 1; ...
            0 0 0 0 0 0 0];
        
        %------------------- mouse 89 -------------------
        sex{3}=1; %male
        surgery{3}=55; %postnatal age on surgery day
        age{3}=80; %postnatal age on first imaging day
        imageduration{3}=158; %minutes from first to last image files
        
        density{3}=[0.21 0.22 0.29 0.30 0.32 0.33 0.37; ...
            0.22 0.16 0.15 0.13 0.09 0.09 0.10; ...
            0.20 0.19 0.16 0.16 0.13 0.19 0.18; ...
            0.18 0.24 0.20 0.20 0.22 0.23 0.22; ...
            0.16 0.21 0.23 0.19 0.17 0.20 0.12; ...
            0.20 0.22 0.20 0.20 0.20 0.16 0.13; ...
            0.24 0.26 0.30 0.33 0.33 0.34 0.33; ...
            0.22 0.26 0.25 0.20 0.29 0.19 0.19; ...
            0.16 0.16 0.18 0.17 0.17 0.16 0.17; ...
            0.18 0.17 0.19 0.18 0.14 0.16 NaN; ...
            0.13 0.12 0.09 0.15 0.12 0.08 0.07; ...
            0.18 0.14 0.06 0.13 0.11 0.17 0.11; ...
            0.28 0.26 0.24 0.24 0.23 0.23 0.25; ...
            0.24 0.22 0.17 NaN NaN NaN NaN; ...
            0.23 0.19 0.23 0.26 0.18 0.14 0.14; ...
            0.22 0.16 0.15 0.12 NaN NaN NaN; ...
            0.14 0.16 0.19 NaN NaN NaN NaN; ...
            0.19 0.13 NaN NaN NaN NaN NaN; ...
            0.22 0.13 NaN NaN NaN NaN NaN; ...
            0.21 0.20 NaN NaN NaN NaN NaN; ...
            NaN NaN 0.23 0.18 0.18 0.18 0.27];
        
        lengths{3}=[152.9 152.9 89.6 89.6 89.6 84.4 84.4; ...
            179.5 179.5 127.1 127.1 127.1 127.1 127.1; ...
            270.6 270.6 228.5 228.5 228.5 228.5 228.5; ...
            197.9 197.9 197.9 197.9 154.3 154.3 154.3; ...
            179.9 179.9 179.9 179.9 179.9 156.6 156.6; ...
            138.2 138.2 138.2 138.2 138.2 138.2 138.2; ...
            146.0 146.0 104.4 104.4 104.4 104.4 104.4; ...
            128.4 128.4 128.4 128.4 128.4 128.4 128.4; ...
            204.0 204.0 204.0 204.0 183.5 183.5 183.5; ...
            341.1 341.1 341.1 341.1 341.1 341.1 NaN; ...
            182.8 182.8 121.9 121.9 121.9 121.9 121.9; ...
            162.0 162.0 83.4 83.4 83.4 83.4 83.4; ...
            177.6 177.6 177.6 177.6 177.6 NaN NaN; ...
            125.2 125.2 62.6 NaN NaN NaN NaN; ...
            236.4 236.4 221.1 221.1 221.1 221.1 221.1; ... %blob nearby but other dendrites survived
            159.9 159.9 98.6 98.6 NaN NaN NaN; ... %blobs nearby but other dendrites survived
            229.9 229.9 NaN NaN NaN NaN NaN; ... %blobs possibly destroyed
            133.3 133.3 NaN NaN NaN NaN NaN; ...
            140.2 140.2 NaN NaN NaN NaN NaN; ... %all the ones I counted disappeared
            117.9 117.9 NaN NaN NaN NaN NaN; ...
            NaN NaN 185.1 185.1 169.4 169.4 76.9]; %last day blob destroyed
        
        count{3}=[32 34 26 27 29 23 31; ...
            39 28 19 17 12 12 13; ...
            54 51 37 36 30 44 40; ...
            36 48 40 40 34 36 34; ...
            27 38 41 34 30 31 19; ...
            28 30 27 28 27 22 18; ...
            35 38 31 34 34 35 34; ...
            28 34 32 26 24 25 25; ...
            32 32 37 35 31 29 31; ...
            61 59 66 60 48 55 NaN; ...
            24 22 6 18 15 10 9; ...
            29 23 3 11 9 14 9; ...
            49 46 42 43 40 30 18; ...
            30 27 16 NaN NaN NaN NaN; ...
            55 44 50 57 40 31 30; ...
            35 25 15 12 NaN NaN NaN; ...
            33 36 16 NaN NaN NaN NaN; ...
            25 17 NaN NaN NaN NaN NaN; ...
            31 18 NaN NaN NaN NaN NaN; ...
            15 23 NaN NaN NaN NaN NaN; ...
            NaN NaN 42 33 31 30 21];
        
        formation{3}=[18.8 17.6 15.4 22.2 17.2 52.2; ...
            10.3 28.6 31.6 17.6 33.3 41.7; ...
            22.2 9.8 21.6 16.7 76.7 22.7; ...
            41.7 16.7 32.5 22.5 29.4 19.4; ...
            33.3 26.3 14.6 20.6 50.0 6.5; ...
            17.9 20.0 25.9 14.3 3.7 27.3; ...
            31.4 21.1 29.0 23.5 23.5 40.0; ...
            25.0 11.8 15.6 19.2 37.5 20.0; ...
            25.0 40.6 13.5 22.9 35.5 37.9; ...
            27.9 30.5 13.6 8.3 35.4 NaN; ...
            25.0 25.0 66.7 27.8 6.7 30.0; ...
            17.2 17.4 NaN 27.3 1.1 28.6; ...
            24.5 34.8 28.6 14.0 22.5 13.3; ...
            20.0 50.0 NaN NaN NaN NaN; ...
            14.5 29.5 32.0 8.8 20.0 25.8; ...
            22.9 28.0 26.7 NaN NaN NaN; ...
            33.3 53.8 NaN NaN NaN NaN; ...
            16.0 NaN NaN NaN NaN NaN; ...
            12.9 NaN NaN NaN NaN NaN; ...
            20.0 NaN NaN NaN NaN NaN; ...
            NaN NaN 7.1 36.4 22.6 23.3];
        
        elim{3}=[12.5 23.5 11.5 14.8 20.7 17.4; ...
            38.5 14.3 42.1 47.1 33.3 33.3; ...
            27.8 21.6 24.3 33.3 30.0 31.8; ...
            8.3 33.3 32.5 10.0 23.5 25.0; ...
            22.2 18.4 31.7 32.4 46.7 45.2; ...
            10.7 30.0 22.2 17.9 22.2 45.5; ...
            22.9 10.5 19.4 23.5 20.6 42.9; ...
            3.6 17.6 34.4 26.9 33.3 20.0; ...
            25.0 25.0 18.9 25.7 41.9 31.0; ...
            31.1 18.6 22.7 28.3 20.8 NaN; ...
            33.3 37.5 0.0 44.4 40.0 40.0; ...
            37.9 NaN 21.7 45.5 55.6 64.3; ...
            30.6 43.5 26.2 20.9 25.0 23.3; ...
            30.0 37.5 NaN NaN NaN NaN; ...
            34.5 13.6 18.0 38.9 42.5 29.0; ...
            24.2 12.0 46.7 NaN NaN NaN; ...
            24.2 38.5 NaN NaN NaN NaN; ...
            48.0 NaN NaN NaN NaN NaN; ...
            54.8 NaN NaN NaN NaN NaN; ...
            28.0 NaN NaN NaN NaN NaN; ...
            NaN NaN 28.6 33.3 25.8 30.0];
        
        %red blobs 1
        %no damage 0
        damagedd{3}=[0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 1 1; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 1 1 0 0 0; ...
            0 0 1 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 0; ...
            0 0 0 0 0 0 1];
        
        %------------------- mouse 129 -------------------
        sex{4}=1; %male
        surgery{4}=122; %postnatal age on surgery day
        age{4}=149; %postnatal age on first imaging day
        imageduration{4}=112; %minutes from first to last image files
        
        density{4}=[0.23 0.18 0.19 NaN NaN NaN NaN; ...
            0.22 0.18 0.16 NaN NaN NaN NaN; ...
            0.32 0.38 0.41 NaN NaN NaN NaN; ...
            0.19 0.13 0.13 NaN NaN NaN NaN; ...
            0.18 0.17 0.15 NaN NaN NaN NaN; ...
            NaN 0.17 0.17 NaN NaN NaN NaN];
        
        lengths{4}=[240.3 240.3 240.3 NaN NaN NaN NaN; ...
            125.6 125.6 125.6 NaN NaN NaN NaN; ...
            95.4 95.4 95.4 NaN NaN NaN NaN; ...
            201.4 201.4 201.4 NaN NaN NaN NaN; ...
            236.4 236.4 236.4 NaN NaN NaN NaN; ...
            NaN 151.9 151.9 NaN NaN NaN NaN];
        
        count{4}=[54 44 46 NaN NaN NaN NaN; ...
            27 23 20 NaN NaN NaN NaN; ...
            30 36 39 NaN NaN NaN NaN; ...
            38 26 26 NaN NaN NaN NaN; ...
            42 39 36 NaN NaN NaN NaN; ...
            NaN 25 26 NaN NaN NaN NaN];
        
        formation{4}=[7.4 29.5 NaN NaN NaN NaN; ...
            18.5 17.4 NaN NaN NaN NaN; ...
            40.0 36.1 NaN NaN NaN NaN; ...
            5.3 30.8 NaN NaN NaN NaN; ...
            23.8 30.8 NaN NaN NaN NaN; ...
            NaN 24.0 NaN NaN NaN NaN];
        
        elim{4}=[25.9 25.0 NaN NaN NaN NaN; ...
            33.3 30.4 NaN NaN NaN NaN; ...
            20.0 27.8 NaN NaN NaN NaN; ...
            36.8 30.8 NaN NaN NaN NaN; ...
            31.0 38.5 NaN NaN NaN NaN; ...
            NaN 20.0 NaN NaN NaN NaN];
        
        damagedd{4}=zeros(size(density{4}));
        
        %------------------- mouse 464, Thy1-GFP -------------------
        sex{5}=1; %sex
        surgery{5}=105; %postnatal age on surgery day
        age{5}=146; %postnatal age on first imaging day
        imageduration{5}=93; %minutes from first to last image files
        
        density{5}=[0.28 0.13 0.23 NaN NaN NaN NaN; ...
            0.20 0.20 0.18 NaN NaN NaN NaN; ...
            0.22 0.16 0.13 NaN NaN NaN NaN; ...
            0.16 0.15 0.13 NaN NaN NaN NaN; ...
            0.27 0.25 0.25 NaN NaN NaN NaN; ...
            0.20 0.16 0.15 NaN NaN NaN NaN; ...
            0.18 0.14 0.12 NaN NaN NaN NaN; ...
            0.30 0.25 0.24 NaN NaN NaN NaN; ...
            0.16 0.18 0.17 NaN NaN NaN NaN];
        
        lengths{5}=[77.4 77.4 77.4 NaN NaN NaN NaN; ...
            65.8 65.8 65.8 NaN NaN NaN NaN; ...
            83.6 83.6 83.6 NaN NaN NaN NaN; ...
            106.0 106.0 106.0 NaN NaN NaN NaN; ...
            51.5 51.5 51.5 NaN NaN NaN NaN; ...
            92.2 92.2 92.2 NaN NaN NaN NaN; ...
            137.2 137.2 137.2 NaN NaN NaN NaN; ...
            241.4 241.4 241.4 NaN NaN NaN NaN; ...
            199.1 199.1 199.1 NaN NaN NaN NaN];
        
        count{5}=[22 10 18 NaN NaN NaN NaN; ...
            13 13 12 NaN NaN NaN NaN; ...
            18 13 11 NaN NaN NaN NaN; ...
            17 16 14 NaN NaN NaN NaN; ...
            14 13 13 NaN NaN NaN NaN; ...
            18 15 14 NaN NaN NaN NaN; ...
            25 19 17 NaN NaN NaN NaN; ...
            72 61 59 NaN NaN NaN NaN; ...
            31 35 34 NaN NaN NaN NaN];
        
        formation{5}=[0 80.0 NaN NaN NaN NaN; ...
            7.7 0 NaN NaN NaN NaN; ...
            11.1 15.4 NaN NaN NaN NaN; ...
            17.7 18.8 NaN NaN NaN NaN; ...
            28.6 15.4 NaN NaN NaN NaN; ...
            16.7 13.3 NaN NaN NaN NaN; ...
            12.0 26.3 NaN NaN NaN NaN; ...
            11.1 14.8 NaN NaN NaN NaN; ...
            25.8 8.6 NaN NaN NaN NaN];
        
        elim{5}=[54.6 0 NaN NaN NaN NaN; ...
            7.7 7.7 NaN NaN NaN NaN; ...
            38.9 30.8 NaN NaN NaN NaN; ...
            23.5 31.3 NaN NaN NaN NaN; ...
            35.7 15.4 NaN NaN NaN NaN; ...
            33.3 20.0 NaN NaN NaN NaN; ...
            36.0 36.8 NaN NaN NaN NaN; ...
            26.4 18.0 NaN NaN NaN NaN; ...
            12.9 11.4 NaN NaN NaN NaN];
        
        damagedd{5}=zeros(size(density{5}));
        
        
        %------------------- mouse 355 YFP -------------------
        sex{6}=1; %sex
        surgery{6}=48; %postnatal age on surgery day
        age{6}=88; %postnatal age on first imaging day
        imageduration{6}=51; %minutes from first to last image files
        
        density{6}=[0.30 0.28 0.23 NaN NaN NaN NaN; ...
            0.30 0.28 0.28 NaN NaN NaN NaN; ...
            0.28 0.28 0.23 NaN NaN NaN NaN; ...
            0.28 0.33 0.36 NaN NaN NaN NaN; ...
            0.47 0.48 0.48 NaN NaN NaN NaN; ...
            0.48 0.38 0.38 NaN NaN NaN NaN];
        
        lengths{6}=[83.4 83.4 83.4 NaN NaN NaN NaN; ...
            108.5 108.5 108.5 NaN NaN NaN NaN; ...
            65.4 65.4 65.4 NaN NaN NaN NaN; ...
            83.0 83.0 83.0 NaN NaN NaN NaN; ...
            171.5 171.5 171.5 NaN NaN NaN NaN; ...
            62.5 62.5 62.5 NaN NaN NaN NaN];
        
        count{6}=[25 23 19 NaN NaN NaN NaN; ...
            33 30 30 NaN NaN NaN NaN; ...
            18 18 15 NaN NaN NaN NaN; ...
            23 27 30 NaN NaN NaN NaN; ...
            81 82 83 NaN NaN NaN NaN; ...
            30 24 24 NaN NaN NaN NaN];
        
        formation{6}=[0 13.0 NaN NaN NaN NaN; ...
            12.1 16.7 NaN NaN NaN NaN; ...
            22.2 5.6 NaN NaN NaN NaN; ...
            26.1 22.2 NaN NaN NaN NaN; ...
            18.5 12.2 NaN NaN NaN NaN; ...
            3.3 20.8 NaN NaN NaN NaN];
        
        elim{6}=[8.0 30.4 NaN NaN NaN NaN; ...
            3.0 16.7 NaN NaN NaN NaN; ...
            22.2 22.2 NaN NaN NaN NaN; ...
            8.7 11.1 NaN NaN NaN NaN; ...
            17.3 11.0 NaN NaN NaN NaN; ...
            23.3 20.8 NaN NaN NaN NaN];
        
        damagedd{6}=zeros(size(density{6}));
        
        %------------------- mouse 353 YFP -------------------
        sex{7}=0; %sex
        surgery{7}=48; %postnatal age on surgery day
        age{7}=88; %postnatal age on first imaging day
        imageduration{7}=49; %minutes from first to last image files
        
        density{7}=[0.35 0.26 0.31 NaN NaN NaN NaN; ...
            0.29 0.27 0.17 NaN NaN NaN NaN; ...
            0.39 0.39 0.35 NaN NaN NaN NaN; ...
            0.27 0.27 0.19 NaN NaN NaN NaN];
        
        lengths{7}=[84.6 84.6 84.6 NaN NaN NaN NaN; ...
            137.8 137.8 137.8 NaN NaN NaN NaN; ...
            31.1 31.1 31.1 NaN NaN NaN NaN; ...
            61.8 61.8 61.8 NaN NaN NaN NaN];
        
        count{7}=[30 22 26 NaN NaN NaN NaN; ...
            40 37 24 NaN NaN NaN NaN; ...
            12 12 11 NaN NaN NaN NaN; ...
            17 17 12 NaN NaN NaN NaN];
        
        formation{7}=[3.3 18.2 NaN NaN NaN NaN; ...
            7.5 10.8 NaN NaN NaN NaN; ...
            8.3 25.0 NaN NaN NaN NaN; ...
            5.9 0 NaN NaN NaN NaN];
        
        elim{7}=[30.0 0 NaN NaN NaN NaN; ...
            15.0 46.0 NaN NaN NaN NaN; ...
            8.3 33.3 NaN NaN NaN NaN; ...
            5.8 29.4 NaN NaN NaN NaN];
        
        damagedd{7}=zeros(size(density{7}));
        
        %------------------- mouse 320 YFP -------------------
        sex{8}=0; %sex
        surgery{8}=48; %postnatal age on surgery day
        age{8}=88; %postnatal age on first imaging day
        imageduration{8}=44; %minutes from first to last image files
        
        density{8}=[0.21 0.21 0.21 NaN NaN NaN NaN];
        
        lengths{8}=[47.1 47.1 47.1 NaN NaN NaN NaN];
        
        count{8}=[10 10 10 NaN NaN NaN NaN];
        
        formation{8}=[20.0 0 NaN NaN NaN NaN];
        
        elim{8}=[20.0 0 NaN NaN NaN NaN];
        
        damagedd{8}=zeros(size(density{8}));
        
    end
    
    for kk=1:numel(density)
        %calculate spine turnover rate
        turnover{kk}=(formation{kk}+elim{kk})/2;
        
        %calculate length change
        lengthchange{kk}=diff(lengths{kk},[],2)./lengths{kk}(:,1:end-1);
        
        %imaging sessions where area seems damaged
        damaged{kk}=damagedd{kk}(:,2:end);
    end
    
    %% plot population average
    subject=[]; sexlist=[]; totaldensity=[]; totallengths=[]; totalcount=[]; totalformation=[]; totalelim=[];
    totalturnover=[]; totallengthchange=[]; totaldamaged=[]; totaldamagedd=[];
    for kk=1:numel(density)
        subject=[subject; kk*ones(size(density{kk},1),1)];
        sexlist=[sexlist; sex{kk}*ones(size(density{kk},1),1)];
        totaldensity=[totaldensity; density{kk}];
        totallengths=[totallengths; lengths{kk}];
        totalcount=[totalcount; count{kk}];
        totalformation=[totalformation; formation{kk}];
        totalelim=[totalelim; elim{kk}];
        totalturnover=[totalturnover; turnover{kk}];
        totallengthchange=[totallengthchange; lengthchange{kk}];
        totaldamaged=[totaldamaged; damaged{kk}];
        totaldamagedd=[totaldamagedd; damagedd{kk}];
    end
    
    %use all measurements
    if jjj==1
        mask=ones(size(subject));
    end
        
    %***only use data with no red blob / photodamage on first 5 sessions
    if jjj==2
        mask=sum(totaldamagedd(:,1:5),2)==0;
    end
    
    overallsubject=[]; overallsex=[]; overalldensity=[]; overalllengths=[];
    overallcount=[]; overallformation=[]; overallelim=[]; overallturnover=[]; overalllengthchange=[];
    for jj=1:numel(mask)
        if mask(jj)==1
            overallsubject=[overallsubject; subject(jj)];
            overallsex=[overallsex; sexlist(jj)];
            overalldensity=[overalldensity; totaldensity(jj,:)];
            overalllengths=[overalllengths; totallengths(jj,:)];
            overallcount=[overallcount; totalcount(jj,:)];
            overallformation=[overallformation; totalformation(jj,:)];
            overallelim=[overallelim; totalelim(jj,:)];
            overallturnover=[overallturnover; totalturnover(jj,:)];
            overalllengthchange=[overalllengthchange; totallengthchange(jj,:)];
        end
    end
    
    %---baseline = first day value, of each ROI
    %     baselinedensity=repmat(overalldensity(:,1),1,size(overalldensity,2));
    %     baselineformation=repmat(overallformation(:,1),1,size(overallformation,2));
    %     baselineelim=repmat(overallelim(:,1),1,size(overallelim,2));
    %----
    
    %---baseline = first day value, averaged for each subject
    for jj=1:numel(overallsubject)
        subjectdensity(jj)=nanmean(overalldensity(overallsubject==overallsubject(jj),1));
        subjectformation(jj)=nanmean(overallformation(overallsubject==overallsubject(jj),1));
        subjectelim(jj)=nanmean(overallelim(overallsubject==overallsubject(jj),1));
    end
    baselinedensity=repmat(subjectdensity',1,size(overalldensity,2));
    baselineformation=repmat(subjectformation',1,size(overallformation,2));
    baselineelim=repmat(subjectelim',1,size(overallelim,2));
    %----
    
    %---divide pre-injection baseline value to obtain fractional change
    normdensity=overalldensity./baselinedensity-1;      % fraction change from first day
    
    %normformation=overallformation./baselineformation-1;    % fraction change from first day
    %normelim=overallelim./baselineelim-1;
    
    %---subtract pre-injection baseline value to obtain difference
    normformation=(overallformation-baselineformation)/100;    % fraction difference from first day
    normelim=(overallelim-baselineelim)/100;
    
    %----for lengths, the only one that makes sense is divide by baseline of first day value of each ROI
    baselinelengths=repmat(overalllengths(:,1),1,size(overalllengths,2));
    normlengths=overalllengths./baselinelengths-1;
    %for length change, no need to normalize to baseline levels
    normlengthchange=overalllengthchange;
    
    %---pro-rate the rates for the last two 5-day sessions (other sessions done in 2 day intervals)
    normformation(:,end-1:end)=2/5*normformation(:,end-1:end);
    normelim(:,end-1:end)=2/5*normelim(:,end-1:end);
    normlengthchange(:,end-1:end)=2/5*normlengthchange(:,end-1:end);
    %---
    
    %%
    %is formation or elimination rate significantly different from baseline?
    
    if jjj==1
        disp(['----- CONTROLS (n=' int2str(numel(density)) ') -----']);
    elseif jjj==2
        disp(['----- KET (n=' int2str(numel(density)) ') -----']);
    end
    disp(['Number of ROI used in 3-session analysis = ' int2str(size(overallformation,1))]);
    disp(['Total number of spines counted, first session = ' int2str(nansum(overallcount(:,1)))]);
    
    longTermSet=(sum(~isnan(overallformation(:,4:6)),2)>0); %at least one of the long-term session is non-zero
    shortTermSet=~longTermSet;
    
    disp(['Number of ROI used in 7-session analysis = ' int2str(sum(longTermSet))]);
    disp(['Total number of spines counted, fourth session = ' int2str(nansum(overallcount(:,4)))]);
    disp(['Mean number of spines counted per ROI = ' int2str(nansum(overallcount(:,1))/size(overallcount,1)) '+-' num2str(nanstd(overallcount(:,1))./sqrt(size(overallcount,1)))]);
    disp(['Total length of dendrites analyzed = ' num2str(nansum(overalllengths(:,1),1)/1000) ' mm']);
    disp(['Mean dendritic lengths analyzed per ROI = ' int2str(nansum(overalllengths(:,1))/size(overalllengths,1)) '+-' num2str(nanstd(overalllengths(:,1))./sqrt(size(overalllengths,1))) 'um']);
    disp(['Mean spine density on 1st day = ' num2str(nanmean(overalldensity(:,1))) '+-' num2str(nanstd(overalldensity(:,1))) 'um-1']);
    
    set1=normformation(normlengths(:,3)<-0.01,2);
    set2=normformation(normlengths(:,3)>=-0.01,2);
    [h,p,ci,stat]=ttest2(set1,set2);
    disp(['Mean change in spine formation rate for ROI with/without dendrite loss = ' num2str(nanmean(set1)) '/' num2str(nanmean(set2)) ' (p=' num2str(p) ')']);
    
    set1=normelim(normlengths(:,3)<-0.01,2);
    set2=normelim(normlengths(:,3)>=-0.01,2);
    [h,p,ci,stat]=ttest2(set1,set2);
    disp(['Mean change in spine elim rate for ROI with/without dendrite loss = ' num2str(nanmean(set1)) '/' num2str(nanmean(set2)) ' (p=' num2str(p) ')']);
    
    set1=normformation(normlengths(:,3)<-0.01,2)-normelim(normlengths(:,3)<-0.01,2);
    set2=normformation(normlengths(:,3)>=-0.01,2)-normelim(normlengths(:,3)>=-0.01,2);
    [h,p,ci,stat]=ttest2(set1,set2);
    disp(['Mean change in spine form-elim rate for ROI with/without dendrite loss = ' num2str(nanmean(set1)) '/' num2str(nanmean(set2)) ' (p=' num2str(p) ')']);
    
    %%
    if jjj==1
        control=ws2struct();
        clearvars -except control
    elseif jjj==2
        ket=ws2struct();
        clearvars -except control ket
    end
end

%%
%Change in Density per field of view
LengthDiff1=minus(ket.lengths{1}(:,2),ket.lengths{1}(:,3));
LengthDiff2=minus(ket.lengths{2}(:,2),ket.lengths{2}(:,3));
LengthDiff3=minus(ket.lengths{3}(:,2),ket.lengths{3}(:,3));
LengthDiff4=minus(ket.lengths{4}(:,2),ket.lengths{4}(:,3));

ChangeDensityR=[times(ket.density{1}(:,2),[minus(ket.lengths{1}(:,2),ket.lengths{1}(:,3))])./ket.lengths{1}(:,2);
    times(ket.density{2}(:,2),[minus(ket.lengths{2}(:,2),ket.lengths{2}(:,3))])./ket.lengths{2}(:,2);
    times(ket.density{3}(:,2),[minus(ket.lengths{3}(:,2),ket.lengths{3}(:,3))])./ket.lengths{3}(:,2);
    times(ket.density{4}(:,2),[minus(ket.lengths{4}(:,2),ket.lengths{4}(:,3))])./ket.lengths{4}(:,2)];

ChangeDensityF=[minus(ket.density{1}(:,3),ket.density{1}(:,2));
    minus(ket.density{2}(:,3),ket.density{2}(:,2));
    minus(ket.density{3}(:,3),ket.density{3}(:,2));
    minus(ket.density{4}(:,3),ket.density{4}(:,2))];

ChangeDensityRmean=nanmean(ChangeDensityR);
ChangeDensityFmean=nanmean(ChangeDensityF);
ChangeDensityRstd=nanstd(ChangeDensityR);
ChangeDensityFstd=nanstd(ChangeDensityF);
ChangeDensityR(ChangeDensityR==0)=NaN;
ChangeDensityF(ChangeDensityF==0)=NaN;
ChangeDensityRmed=nanmedian(ChangeDensityR);
ChangeDensityFmed=nanmedian(ChangeDensityF);

disp('mean of Change in Density from Dendritic Retraction: ');
ChangeDensityRmean
disp('mean of Change in Density from Spine Formation: ');
ChangeDensityFmean
disp('standard deviation of Change in Density from Dendritic Retraction: ');
ChangeDensityRstd
disp('standard deviation of Change in Density from Spine Formation: ');
ChangeDensityFstd
disp('median of Change in Density from Dendritic Retraction: ');
ChangeDensityRmed
disp('median of Change in Density from Spine Formation: ');
ChangeDensityFmed

%Change in Density using sums and averages

meanDensityDay3=mean([nanmean(ket.density{1}(:,3)) nanmean(ket.density{2}(:,3)) nanmean(ket.density{3}(:,3)) nanmean(ket.density{4}(:,3))]);
meanDensityDay2=mean([nanmean(ket.density{1}(:,2)) nanmean(ket.density{2}(:,2)) nanmean(ket.density{3}(:,2)) nanmean(ket.density{4}(:,2))]);

sumlosslength=sum([nansum(LengthDiff1) nansum(LengthDiff2) nansum(LengthDiff3) nansum(LengthDiff4)]);
sumlengths=sum([nansum(ket.lengths{1}(:,2)) nansum(ket.lengths{2}(:,2)) nansum(ket.lengths{3}(:,2)) nansum(ket.lengths{4}(:,2))]);

disp('Total Change in Density from Dendritic Retraction: ');
totalChangeDensityR=times(meanDensityDay2, sumlosslength)./sumlengths
disp('Total Change in Density from Spine Formation: ');
totalChangeDensityF=minus(meanDensityDay2, meanDensityDay3)

%% absolute numbers
temp=[];
for jj=1:numel(ket.count)
    temp=[temp; ket.count{jj}(:,1)];
end
for jj=1:numel(control.count)
    temp=[temp; control.count{jj}(:,1)];
end
disp('Mean and std.dev. of #spines counted per field of view = ');
nanmean(temp)
nanstd(temp)

temp=[];
for jj=1:numel(ket.density)
    temp=[temp; ket.density{jj}(:,1)];
end
for jj=1:numel(control.density)
    temp=[temp; control.density{jj}(:,1)];
end
disp('Mean and std.dev. of spine density per field of view = ');
nanmean(temp)
nanstd(temp)

tempK=[];
for jj=1:numel(ket.density)
    tempK=[tempK; ket.density{jj}(:,1)];
end
tempC=[];
for jj=1:numel(control.density)
    tempC=[tempC; control.density{jj}(:,1)];
end
[p,h]=ranksum(tempK,tempC)

%% two-way ANOVA between control and ket
for kk=1:2
    if kk==1
        numDay=3;
        ketdataMask=ket.shortTermSet | ket.longTermSet;    %use all data
        controldataMask=control.shortTermSet | control.longTermSet;    %use all data
        numROIcontrol=sum(controldataMask);
        numROIket=sum(ketdataMask);
        numSubjectcontrol=numel(unique(control.overallsubject(controldataMask)));
        numSubjectket=numel(unique(ket.overallsubject(ketdataMask)));
    elseif kk==2
        numDay=7;
        ketdataMask=ket.longTermSet;    %use only experiments intended for long-term
        controldataMask=control.longTermSet;    %use only experiments intended for long-term
        numROIcontrol=sum(controldataMask);
        numROIket=sum(ketdataMask);
        numSubjectcontrol=numel(unique(control.overallsubject(controldataMask)));
        numSubjectket=numel(unique(ket.overallsubject(ketdataMask)));
    end
    
    disp('---------------------------------------');
    disp(['--- PER SUBJECT: ' int2str(numDay) '-day analysis; #Subject=' int2str(numSubjectcontrol) '/' int2str(numSubjectket) ' for control/ket ------------------------------------']);
    disp('---------------------------------------');
    
    densityList=[]; lengthList=[]; formList=[]; elimList=[]; treatmentList=[]; subjectList=[]; dayList=[];
    for jj=unique(ket.overallsubject(ketdataMask))'
        temp=nanmean(ket.normdensity(ket.overallsubject==jj,:),1);
        densityList=[densityList temp(2:numDay)];
        temp=nanmean(ket.normlengths(ket.overallsubject==jj,:),1);
        lengthList=[lengthList temp(2:numDay)];
        temp=nanmean(ket.normformation(ket.overallsubject==jj,:),1);
        formList=[formList temp(1:numDay-1)];
        temp=nanmean(ket.normelim(ket.overallsubject==jj,:),1);
        elimList=[elimList temp(1:numDay-1)];
        treatmentList=[treatmentList 1*ones(1,numDay-1)];
        subjectList=[subjectList jj*ones(1,numDay-1)];
        dayList=[dayList 1:numDay-1];
    end
    for jj=unique(control.overallsubject(controldataMask))'
        temp=nanmean(control.normdensity(control.overallsubject==jj,:),1);
        densityList=[densityList temp(2:numDay)];
        temp=nanmean(control.normlengths(control.overallsubject==jj,:),1);
        lengthList=[lengthList temp(2:numDay)];
        temp=nanmean(control.normformation(control.overallsubject==jj,:),1);
        formList=[formList temp(1:numDay-1)];
        temp=nanmean(control.normelim(control.overallsubject==jj,:),1);
        elimList=[elimList temp(1:numDay-1)];
        treatmentList=[treatmentList 0*ones(1,numDay-1)];
        subjectList=[subjectList (jj+10)*ones(1,numDay-1)];
        dayList=[dayList 1:numDay-1];
    end
    
    %repeated measures ANOVA
    disp('------ Spine density ------');
    %https://www.mathworks.com/matlabcentral/newsreader/view_thread/58226
    terms=[1 0 0; 0 1 0; 1 1 0];
    [pDensity,tableDensity,statsDensity]=anovan(densityList,{treatmentList dayList subjectList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'Subjects'},'display','off');
    tableDensity
    
    disp('------ Dendrite length ------');
    [pLength,tableLength,statsLength]=anovan(lengthList,{treatmentList dayList subjectList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'Subjects'},'display','off');
    tableLength
    
    disp('------ Spine formation rate ------');
    [pForm,tableForm,statsForm]=anovan(formList,{treatmentList dayList subjectList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'Subjects'},'display','off');
    tableForm
    
    disp('------ Spine elim rate ------');
    [pElim,tableElim,statsElim]=anovan(elimList,{treatmentList dayList subjectList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'Subjects'},'display','off');
    tableElim
    
    %%
    disp('---------------------------------------');
    disp(['--- PER ROI: ' int2str(numDay) '-day analysis; #ROI=' int2str(numROIcontrol) '/' int2str(numROIket) ' for control/ket ------------------------------------']);
    disp('---------------------------------------');
    
    temp1=ket.normdensity(ketdataMask,2:numDay);        %spine density, ket
    temp2=control.normdensity(controldataMask,2:numDay);    %spine density, control
    densityList=[temp1(:); temp2(:)];
    
    temp1=ket.normlengths(ketdataMask,2:numDay);        %dendritic length, ket
    temp2=control.normlengths(controldataMask,2:numDay);    %dendritic length, control
    lengthList=[temp1(:); temp2(:)];
    
    temp1=ket.normdensity(ketdataMask,2:numDay);
    temp2=control.normdensity(controldataMask,2:numDay);
    treatmentList=[ones(numel(temp1),1); zeros(numel(temp2),1)]; %which treatment, ket or control
    
    temp1=repmat([2:numDay],size(temp1,1),1);
    temp2=repmat([2:numDay],size(temp2,1),1);
    dayList=[temp1(:); temp2(:)];               %which imaging session
    
    temp1=repmat([1:numROIket],1,numDay-1);
    temp2=repmat([1:numROIcontrol],1,numDay-1);
    fovList=[temp1(:); temp2(:)];
    
    temp1=repmat(ket.overallsubject,1,3);
    temp2=repmat(control.overallsubject,1,3)+max(ket.overallsubject);
    subjectList=[temp1(:); temp2(:)];           %which subject
    temp1=ket.normdensity(:,1:numDay);
    temp2=control.normdensity(:,1:numDay);
    temp1=repmat([1:size(temp1,1)]',1,3);
    temp2=repmat([1:size(temp2,1)]',1,3)+size(temp1,1);
    roiList=[temp1(:); temp2(:)];               %which ROI
    
    %repeated measures ANOVA
    %https://www.mathworks.com/matlabcentral/newsreader/view_thread/58226
    disp('------ Spine density ------');
    terms=[1 0 0; 0 1 0; 1 1 0];
    [pDensity,tableDensity,statsDensity]=anovan(densityList,{treatmentList dayList fovList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'FOVs'},'display','off');
    tableDensity
    
    disp('------ Dendrite length ------');
    [pLength,tableLength,statsLength]=anovan(lengthList,{treatmentList dayList fovList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'FOVs'},'display','off');
    tableLength
    
    temp1=ket.normformation(ketdataMask,1:numDay-1);        %spine density, ket
    temp2=control.normformation(controldataMask,1:numDay-1);    %spine density, control
    formList=[temp1(:); temp2(:)];
    temp1=ket.normelim(ketdataMask,1:numDay-1);        %spine density, ket
    temp2=control.normelim(controldataMask,1:numDay-1);    %spine density, control
    elimList=[temp1(:); temp2(:)];
    temp1=ket.normformation(ketdataMask,1:numDay-1);
    temp2=control.normformation(controldataMask,1:numDay-1);
    treatmentList=[ones(numel(temp1),1); zeros(numel(temp2),1)]; %which treatment, ket or control
    temp1=repmat([1:numDay-1],size(temp1,1),1);
    temp2=repmat([1:numDay-1],size(temp2,1),1);
    dayList=[temp1(:); temp2(:)];               %which imaging session
    temp1=repmat([1:numROIket],1,numDay-1);
    temp2=repmat([1:numROIcontrol],1,numDay-1);
    fovList=[temp1(:); temp2(:)];
    
    %repeated measures ANOVA
    %https://www.mathworks.com/matlabcentral/newsreader/view_thread/58226
    disp('------ Spine formation rate ------');
    [pForm,tableForm,statsForm]=anovan(formList,{treatmentList dayList fovList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'FOVs'},'display','off');
    tableForm
    
    disp('------ Spine elim rate ------');
    [pElim,tableElim,statsElim]=anovan(elimList,{treatmentList dayList fovList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'FOVs'},'display','off');
    tableElim
    
    %% plot changes in spine density, dendritic length, formation and elim rates
    figure;
    temp1=control.normdensity(controldataMask,:); temp2=ket.normdensity(ketdataMask,:);
    subplot(2,2,1); hold on;
    errorbar(control.days(1:numDay),100*nanmean(temp1(:,1:numDay),1),100*nanstd(temp1(:,1:numDay),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
    errorbar(ket.days(1:numDay),100*nanmean(temp2(:,1:numDay),1),100*nanstd(temp2(:,1:numDay),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
    plot([0 0],[-40 10],'k--','LineWidth',1);
    xlabel('Days from injection'); ylabel('Fold-change (%)');
    title('Spine density');
    ylim([-40 10]); xlim([control.days(1)-1 control.days(numDay)+1]);
    set(gca,'XTick',control.days);
    legend('Saline','Ketamine','location','Southeast');
    legend('boxoff');
    
    if kk==1
        temp1=control.normlengths(controldataMask,:); temp2=ket.normlengths(ketdataMask,:);
        subplot(2,2,2); hold on;
        plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
        %plot([0 0],[-40 10],'k--','LineWidth',1);
        errorbar(control.days(:,1:numDay),100*nanmean(temp1(:,1:numDay),1),100*nanstd(temp1(:,1:numDay),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
        errorbar(ket.days(1:numDay),100*nanmean(temp2(:,1:numDay),1),100*nanstd(temp2(:,1:numDay),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
        xlabel('Days from injection'); ylabel('Fold-change (%)');
        title('Dendritic length');
        ylim([-30 10]); xlim([control.days(1)-1 control.days(numDay)+1]);
        set(gca,'XTick',control.days);
    end
    
    if kk==2
        temp1=control.normlengthchange(controldataMask,:); temp2=ket.normlengthchange(ketdataMask,:);
        subplot(2,2,2); hold on;
        plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
        plot([0 0],[-40 10],'k--','LineWidth',1);
        errorbar(1:numDay-1,100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
        errorbar(1:numDay-1,100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIket),'bs','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
        xlabel('Sessions'); ylabel('Fold-change (%)');
        title('Length change between sessions');
        ylim([-30 10]); xlim([0 numDay]);
        set(gca,'XTick',1:numDay-1);
    end
    
    if kk==1
        temp1=control.normformation(controldataMask,:); temp2=ket.normformation(ketdataMask,:);
        subplot(2,2,3); hold on;
        errorbar(control.diffdays(1:numDay-1),100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
        errorbar(ket.diffdays(1:numDay-1),100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
        plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
        plot([0 0],[-15 15],'k--','LineWidth',1);
        xlabel('Days from injection'); ylabel('Difference (%)');
        title('Spine formation rate');
        ylim([-15 15]); xlim([-2 control.days(numDay)+1]);
        set(gca,'XTick',control.days);
        legend('Saline','Ketamine','location','Southeast');
        legend('boxoff');
        
        temp1=control.normelim(controldataMask,:); temp2=ket.normelim(ketdataMask,:);
        subplot(2,2,4); hold on;
        plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
        plot([0 0],[-15 15],'k--','LineWidth',1);
        errorbar(control.diffdays(1:numDay-1),100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
        errorbar(ket.diffdays(1:numDay-1),100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
        xlabel('Days from injection'); ylabel('Difference (%)');
        title('Spine elimination rate');
        ylim([-15 15]); xlim([-2 control.days(numDay)+1]);
        set(gca,'XTick',control.days);
    elseif kk==2
        temp1=ket.normformation(ketdataMask,:); temp2=ket.normelim(ketdataMask,:);
        subplot(2,2,3); hold on;
        errorbar(ket.diffdays(1:numDay-1),100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
        errorbar(ket.diffdays(1:numDay-1),100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2);
        plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
        plot([0 0],[-15 15],'k--','LineWidth',1);
        xlabel('Days from injection'); ylabel('Difference (%)');
        title('Ketamine');
        ylim([-15 15]); xlim([control.days(1)-1 control.days(numDay)+1]);
        set(gca,'XTick',control.days);
        legend('Formation','Elimination','location','Southeast');
        legend('boxoff');
        
        temp1=control.normformation(controldataMask,:); temp2=control.normelim(controldataMask,:);
        subplot(2,2,4); hold on;
        errorbar(control.diffdays(1:numDay-1),100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
        errorbar(control.diffdays(1:numDay-1),100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2);
        plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
        plot([0 0],[-15 15],'k--','LineWidth',1);
        xlabel('Days from injection'); ylabel('Difference (%)');
        title('Saline');
        ylim([-15 15]); xlim([control.days(1)-1 control.days(numDay)+1]);
        set(gca,'XTick',control.days);
        legend('Formation','Elimination','location','Southeast');
        legend('boxoff');
    end
    
    set(gcf,'Position',[40 40 800 800]);  %laptop
    set(gcf, 'PaperPositionMode', 'auto');

    %% divide by sex: plot changes in spine density, dendritic length, formation and elim rates
    if kk==1
    figure;
    subplot(2,2,1); hold on;
%     temp1=control.normdensity(controldataMask & control.overallsex==0,:); temp2=ket.normdensity(ketdataMask & ket.overallsex==0,:);
%     errorbar(control.days(1:numDay),100*nanmean(temp1(:,1:numDay),1),100*nanstd(temp1(:,1:numDay),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
%     errorbar(ket.days(1:numDay),100*nanmean(temp2(:,1:numDay),1),100*nanstd(temp2(:,1:numDay),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    temp1=control.normdensity(controldataMask & control.overallsex==1,:); temp2=ket.normdensity(ketdataMask & ket.overallsex==1,:);
    errorbar(control.days(1:numDay),100*nanmean(temp1(:,1:numDay),1),100*nanstd(temp1(:,1:numDay),[],1)/sqrt(numROIcontrol),'ko--','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
    errorbar(ket.days(1:numDay),100*nanmean(temp2(:,1:numDay),1),100*nanstd(temp2(:,1:numDay),[],1)/sqrt(numROIket),'bs--','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
    plot([0 0],[-40 10],'k--','LineWidth',1);
    xlabel('Days from injection'); ylabel('Fold-change (%)');
    title('Spine density');
    ylim([-40 10]); xlim([control.days(1)-1 control.days(numDay)+1]);
    set(gca,'XTick',control.days);
    legend('Saline, male','Ketamine, male','location','Southeast');
    legend('boxoff');
    
    subplot(2,2,2); hold on;
    plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
    %plot([0 0],[-40 10],'k--','LineWidth',1);
%     temp1=control.normlengths(controldataMask & control.overallsex==0,:); temp2=ket.normlengths(ketdataMask & ket.overallsex==0,:);
%     errorbar(control.days(:,1:numDay),100*nanmean(temp1(:,1:numDay),1),100*nanstd(temp1(:,1:numDay),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
%     errorbar(ket.days(1:numDay),100*nanmean(temp2(:,1:numDay),1),100*nanstd(temp2(:,1:numDay),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    temp1=control.normlengths(controldataMask & control.overallsex==1,:); temp2=ket.normlengths(ketdataMask & ket.overallsex==1,:);
    errorbar(control.days(:,1:numDay),100*nanmean(temp1(:,1:numDay),1),100*nanstd(temp1(:,1:numDay),[],1)/sqrt(numROIcontrol),'ko--','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
    errorbar(ket.days(1:numDay),100*nanmean(temp2(:,1:numDay),1),100*nanstd(temp2(:,1:numDay),[],1)/sqrt(numROIket),'bs--','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    xlabel('Days from injection'); ylabel('Fold-change (%)');
    title('Dendritic length');
    ylim([-40 10]); xlim([control.days(1)-1 control.days(numDay)+1]);
    set(gca,'XTick',control.days);
    
    subplot(2,2,3); hold on;
%     temp1=control.normformation(controldataMask & control.overallsex==0,:); temp2=ket.normformation(ketdataMask & ket.overallsex==0,:);
%     errorbar(control.diffdays(1:numDay-1),100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
%     errorbar(ket.diffdays(1:numDay-1),100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    temp1=control.normformation(controldataMask & control.overallsex==1,:); temp2=ket.normformation(ketdataMask & ket.overallsex==1,:);
    errorbar(control.diffdays(1:numDay-1),100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko--','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
    errorbar(ket.diffdays(1:numDay-1),100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIket),'bs--','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
    plot([0 0],[-15 15],'k--','LineWidth',1);
    xlabel('Days from injection'); ylabel('Difference (%)');
    title('Spine formation rate');
    ylim([-15 15]); xlim([-2 control.days(numDay)+1]);
    set(gca,'XTick',control.days);
    legend('Saline, male','Ketamine, male','location','Southeast');
    legend('boxoff');
    
    subplot(2,2,4); hold on;
    plot([control.days(1)-1 control.days(end)+1],[0 0],'k-','LineWidth',1);
    plot([0 0],[-15 15],'k--','LineWidth',1);
%     temp1=control.normelim(controldataMask & control.overallsex==0,:); temp2=ket.normelim(ketdataMask & ket.overallsex==0,:);
%     errorbar(control.diffdays(1:numDay-1),100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
%     errorbar(ket.diffdays(1:numDay-1),100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIket),'bs-','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    temp1=control.normelim(controldataMask & control.overallsex==1,:); temp2=ket.normelim(ketdataMask & ket.overallsex==1,:);
    errorbar(control.diffdays(1:numDay-1),100*nanmean(temp1(:,1:numDay-1),1),100*nanstd(temp1(:,1:numDay-1),[],1)/sqrt(numROIcontrol),'ko--','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','k');
    errorbar(ket.diffdays(1:numDay-1),100*nanmean(temp2(:,1:numDay-1),1),100*nanstd(temp2(:,1:numDay-1),[],1)/sqrt(numROIket),'bs--','MarkerSize',12,'LineWidth',2,'MarkerFaceColor','b');
    xlabel('Days from injection'); ylabel('Difference (%)');
    title('Spine elimination rate');
    ylim([-15 15]); xlim([-2 control.days(numDay)+1]);
    set(gca,'XTick',control.days);
    legend('Saline, male','Ketamine, male','location','Southeast');
    legend('boxoff');
    
    set(gcf,'Position',[40 40 800 800]);  %laptop
    set(gcf, 'PaperPositionMode', 'auto');

    disp('---------------------------------------');
    disp(['--- PER ROI: ' int2str(numDay) '-day analysis; #ROI=' int2str(numROIcontrol) '/' int2str(numROIket) ' for control/ket ------------------------------------']);
    disp('---------------------------------------');
    
    temp1=ket.normdensity(ketdataMask & ket.overallsex==1,2:numDay);        %spine density, ket
    temp2=control.normdensity(controldataMask & control.overallsex==1,2:numDay);    %spine density, control
    densityList=[temp1(:); temp2(:)];
    
    temp1=ket.normlengths(ketdataMask & ket.overallsex==1,2:numDay);        %dendritic length, ket
    temp2=control.normlengths(controldataMask & control.overallsex==1,2:numDay);    %dendritic length, control
    lengthList=[temp1(:); temp2(:)];
    
    temp1=ket.normdensity(ketdataMask & ket.overallsex==1,2:numDay);
    temp2=control.normdensity(controldataMask & control.overallsex==1,2:numDay);
    treatmentList=[ones(numel(temp1),1); zeros(numel(temp2),1)]; %which treatment, ket or control
    
    temp1=repmat([2:numDay],size(temp1,1),1);
    temp2=repmat([2:numDay],size(temp2,1),1);
    dayList=[temp1(:); temp2(:)];               %which imaging session
    
    temp1=repmat([1:sum(ket.overallsex==1)],1,numDay-1);
    temp2=repmat([1:sum(control.overallsex==1)],1,numDay-1);
    fovList=[temp1(:); temp2(:)];
    
    temp1=repmat(ket.overallsubject(ket.overallsex==1),1,3);
    temp2=repmat(control.overallsubject(control.overallsex==1),1,3)+max(ket.overallsubject(ket.overallsex==1));
    subjectList=[temp1(:); temp2(:)];           %which subject
    
    %repeated measures ANOVA
    %https://www.mathworks.com/matlabcentral/newsreader/view_thread/58226
    disp('------ Spine density ------');
    terms=[1 0 0; 0 1 0; 1 1 0];
    [pDensity,tableDensity,statsDensity]=anovan(densityList,{treatmentList dayList fovList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'FOVs'},'display','off');
    tableDensity
    
    disp('------ Dendrite length ------');
    [pLength,tableLength,statsLength]=anovan(lengthList,{treatmentList dayList fovList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'FOVs'},'display','off');
    tableLength
    
    temp1=ket.normformation(ketdataMask & ket.overallsex==1,1:numDay-1);        %spine density, ket
    temp2=control.normformation(controldataMask & control.overallsex==1,1:numDay-1);    %spine density, control
    formList=[temp1(:); temp2(:)];
    temp1=ket.normelim(ketdataMask & ket.overallsex==1,1:numDay-1);        %spine density, ket
    temp2=control.normelim(controldataMask & control.overallsex==1,1:numDay-1);    %spine density, control
    elimList=[temp1(:); temp2(:)];
    temp1=ket.normformation(ketdataMask & ket.overallsex==1,1:numDay-1);
    temp2=control.normformation(controldataMask & control.overallsex==1,1:numDay-1);
    treatmentList=[ones(numel(temp1),1); zeros(numel(temp2),1)]; %which treatment, ket or control
    temp1=repmat([1:numDay-1],size(temp1,1),1);
    temp2=repmat([1:numDay-1],size(temp2,1),1);
    dayList=[temp1(:); temp2(:)];               %which imaging session
    temp1=repmat([1:sum(ket.overallsex==1)],1,numDay-1);
    temp2=repmat([1:sum(control.overallsex==1)],1,numDay-1);
    fovList=[temp1(:); temp2(:)];
    
    %repeated measures ANOVA
    %https://www.mathworks.com/matlabcentral/newsreader/view_thread/58226
    disp('------ Spine formation rate ------');
    [pForm,tableForm,statsForm]=anovan(formList,{treatmentList dayList fovList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'FOVs'},'display','off');
    tableForm
    
    disp('------ Spine elim rate ------');
    [pElim,tableElim,statsElim]=anovan(elimList,{treatmentList dayList fovList},'random',3,'nested',[0 0 0; 0 0 0; 1 0 0],'model',terms,'varnames',{'Ketamine' 'Days' 'FOVs'},'display','off');
    tableElim
    end
    
    %% --- plot histogram of changes per FOV
    if kk==1
        figure;
        subplot(3,1,1); hold on;
        plot([0 0],[0 40],'k','LineWidth',1);
        edges=[-1:0.1:1]+0.05;
        nControl=histc(control.normdensity(controldataMask,3),edges);
        b=bar(100*(edges+mean(diff(edges))/2),100*[nControl/sum(nControl)],'BarWidth',1);
        set(b(1),'FaceColor','k');
        xlabel('Spine density, fold-change from day -3 to day 1 (%)');
        ylabel('Fraction of fields of view (%)');
        xlim([-85 85]); ylim([0 30]);
        
        subplot(3,1,2); hold on;
        plot([0 0],[0 40],'k','LineWidth',1);
        edges=[-1:0.1:1]+0.05;
        nKet=histc(ket.normdensity(ketdataMask,3),edges);
        b=bar(100*(edges+mean(diff(edges))/2),100*[nKet/sum(nKet)],'BarWidth',1);
        set(b(1),'FaceColor','b');
        xlabel('Spine density, fold-change from day -3 to day 1 (%)');
        ylabel('Fraction of fields of view (%)');
        xlim([-85 85]); ylim([0 30]);
        
        subplot(3,1,3); hold on;
        plot([0 0],[0 120],'k','LineWidth',1);
        edges=[-1:0.1:1]+0.05;
        nControl=histc(control.normlengths(controldataMask,3),edges);
        nKet=histc(ket.normlengths(ketdataMask,3),edges);
        b=bar(100*(edges+mean(diff(edges))/2),100*[nControl/sum(nControl) nKet/sum(nKet)],'BarWidth',1);
        set(b(1),'FaceColor','k');
        set(b(2),'FaceColor','b');
        xlabel('Dendritic length, fold-change from day -3 to day 1 (%)');
        ylabel('Fraction of fields of view (%)');
        xlim([-80 80]);
        
        set(gcf,'Position',[40 40 900 800]);  %laptop
        set(gcf, 'PaperPositionMode', 'auto');
        
        disp('# ROI with spine density <0 and >=0, control');
        [sum(control.normdensity(controldataMask,3)<0) sum(control.normdensity(controldataMask,3)>=0)]
        disp('# ROI with spine density <0 and >=0, ket');
        [sum(ket.normdensity(ketdataMask,3)<0) sum(ket.normdensity(ketdataMask,3)>=0)]
        
        %chi-square test of equality between proportions
        n1 = sum(control.normdensity(controldataMask,3)>=0); N1 = sum(controldataMask);
        n2 = sum(ket.normdensity(ketdataMask,3)>=0); N2 = sum(ketdataMask);
        % Pooled estimate of proportion
        p0 = (n1+n2) / (N1+N2);
        % Expected counts under H0 (null hypothesis)
        n10 = N1 * p0;
        n20 = N2 * p0;
        % Chi-square test, by hand
        observed = [n1 N1-n1 n2 N2-n2];
        expected = [n10 N1-n10 n20 N2-n20];
        disp('Chi-square test of equality between proportions');
        chi2stat = sum((observed-expected).^2 ./ expected)
        p = 1 - chi2cdf(chi2stat,1)
        
        disp('# ROI with branch length <-0.01 and >=-0.01, ket');
        [sum(ket.normlengths(ketdataMask,3)<-0.01) sum(ket.normlengths(ketdataMask,3)>=-0.01)]
        
    end
    
    %% plot factors that could influence spine density
    
    if kk==1
        % spine density level on day -1 per subject
        densityPerSubject=[];
        subjectID=unique(ket.overallsubject);
        for jj=1:numel(subjectID)
            densityPerSubject=[densityPerSubject nanmean(ket.normdensity(ket.overallsubject==subjectID(jj),2),1)];
        end
        subjectID=unique(control.overallsubject);
        for jj=1:numel(subjectID)
            densityPerSubject=[densityPerSubject nanmean(control.normdensity(control.overallsubject==subjectID(jj),2),1)];
        end
        
        ketPerSubject=[1*ones(1,numel(unique(ket.overallsubject))) 0*ones(1,numel(unique(control.overallsubject)))];
        sexPerSubject=cell2mat([ket.sex control.sex]);
        surgeryPerSubject=cell2mat([ket.surgery control.surgery]);
        agePerSubject=cell2mat([ket.age control.age]);
        imagedurationPerSubject=cell2mat([ket.imageduration control.imageduration]);
        
        figure;
        disp('Diff in spine density: to-be-saline vs to-be-ket subjects');
        p=ranksum(densityPerSubject(ketPerSubject==0),densityPerSubject(ketPerSubject==1))
        subplot(2,3,1); hold on;
        plot(1*ones(1,sum(ketPerSubject==0 & sexPerSubject==0))-0.3*rand(1,sum(ketPerSubject==0 & sexPerSubject==0)),densityPerSubject(ketPerSubject==0 & sexPerSubject==0),'k+','MarkerSize',12,'LineWidth',2);
        plot(1*ones(1,sum(ketPerSubject==0 & sexPerSubject==1))-0.3*rand(1,sum(ketPerSubject==0 & sexPerSubject==1)),densityPerSubject(ketPerSubject==0 & sexPerSubject==1),'ko','MarkerSize',10,'LineWidth',2);
        plot(1+0.2,nanmean(densityPerSubject(ketPerSubject==0)),'k^','MarkerSize',10,'LineWidth',2);
        plot(1+[0.2 0.2],nanmean(densityPerSubject(ketPerSubject==0))+nanstd(densityPerSubject(ketPerSubject==0))/sqrt(sum(ketPerSubject==0))*[-1 1],'k-','LineWidth',2);
        plot(2*ones(1,sum(ketPerSubject==1 & sexPerSubject==0))-0.3*rand(1,sum(ketPerSubject==1 & sexPerSubject==0)),densityPerSubject(ketPerSubject==1 & sexPerSubject==0),'k+','MarkerSize',12,'LineWidth',2);
        plot(2*ones(1,sum(ketPerSubject==1 & sexPerSubject==1))-0.3*rand(1,sum(ketPerSubject==1 & sexPerSubject==1)),densityPerSubject(ketPerSubject==1 & sexPerSubject==1),'ko','MarkerSize',10,'LineWidth',2);
        plot(2+0.2,nanmean(densityPerSubject(ketPerSubject==1)),'k^','MarkerSize',10,'LineWidth',2);
        plot(2+[0.2 0.2],nanmean(densityPerSubject(ketPerSubject==1))+nanstd(densityPerSubject(ketPerSubject==1))/sqrt(sum(ketPerSubject==0))*[-1 1],'k-','LineWidth',2);
        set(gca,'xticklabel',{'Saline' 'Ketamine'},'xtick',1:1:2);
        xlabel('Treatment to be applied');
        ylabel('Fold-change');
        title('Spine density');
        xlim([0 3]);
        
        subplot(2,3,2); hold on;
        disp('Diff in spine density: male vs female');
        p=ranksum(densityPerSubject(sexPerSubject==0),densityPerSubject(sexPerSubject==1))
        plot(1*ones(1,sum(sexPerSubject==0))-0.3*rand(1,sum(sexPerSubject==0)),densityPerSubject(sexPerSubject==0),'k+','MarkerSize',12,'LineWidth',2);
        plot(1+0.2,nanmean(densityPerSubject(sexPerSubject==0)),'k^','MarkerSize',10,'LineWidth',2);
        plot(1+[0.2 0.2],nanmean(densityPerSubject(sexPerSubject==0))+nanstd(densityPerSubject(sexPerSubject==0))/sqrt(sum(sexPerSubject==0))*[-1 1],'k-','LineWidth',2);
        plot(2*ones(1,sum(sexPerSubject==1))-0.3*rand(1,sum(sexPerSubject==1)),densityPerSubject(sexPerSubject==1),'ko','MarkerSize',10,'LineWidth',2);
        plot(2+0.2,nanmean(densityPerSubject(sexPerSubject==1)),'k^','MarkerSize',10,'LineWidth',2);
        plot(2+[0.2 0.2],nanmean(densityPerSubject(sexPerSubject==1))+nanstd(densityPerSubject(sexPerSubject==1))/sqrt(sum(sexPerSubject==0))*[-1 1],'k-','LineWidth',2);
        set(gca,'xticklabel',{'Female' 'Male'},'xtick',1:1:2);
        xlabel('Sex');
        ylabel('Fold-change');
        title('Spine density');
        xlim([0 3]);
        
        disp('Slope of spine density: imaging duration');
        stats=regstats(densityPerSubject,imagedurationPerSubject,'linear');
        stats.tstat.pval(2)
        subplot(2,3,4); hold on;
        plot(imagedurationPerSubject(sexPerSubject==0),densityPerSubject(sexPerSubject==0),'k+','MarkerSize',12,'LineWidth',2);
        plot(imagedurationPerSubject(sexPerSubject==1),densityPerSubject(sexPerSubject==1),'ko','MarkerSize',10,'LineWidth',2);
        plot([30:1:160],[30:1:160]*stats.tstat.beta(2)+stats.tstat.beta(1),'k-','LineWidth',2);
        xlabel('Duration of first imaging session (min)');
        ylabel('Fold-change');
        title('Spine density');
        xlim([0 180]); ylim([-0.35 0.05]);

        disp('Slope of spine density: age on surgery day');
        stats=regstats(densityPerSubject,surgeryPerSubject,'linear');
        stats.tstat.pval(2)
        subplot(2,3,5); hold on;
        plot(surgeryPerSubject(sexPerSubject==0),densityPerSubject(sexPerSubject==0),'k+','MarkerSize',12,'LineWidth',2);
        plot(surgeryPerSubject(sexPerSubject==1),densityPerSubject(sexPerSubject==1),'ko','MarkerSize',10,'LineWidth',2);
        plot([50:1:130],[50:1:130]*stats.tstat.beta(2)+stats.tstat.beta(1),'k-','LineWidth',2);
        xlabel('Age on surgery day (postnatal day)');
        ylabel('Fold-change');
        title('Spine density');
        xlim([40 160]); ylim([-0.35 0.05]);
        
        disp('Slope of spine density: age on first imaging day');
        stats=regstats(densityPerSubject,agePerSubject,'linear');
        stats.tstat.pval(2)
        subplot(2,3,6); hold on;
        plot(agePerSubject(sexPerSubject==0),densityPerSubject(sexPerSubject==0),'k+','MarkerSize',12,'LineWidth',2);
        plot(agePerSubject(sexPerSubject==1),densityPerSubject(sexPerSubject==1),'ko','MarkerSize',10,'LineWidth',2);
        plot([70:1:150],[70:1:150]*stats.tstat.beta(2)+stats.tstat.beta(1),'k-','LineWidth',2);
        xlabel('Age on first imaging session (postnatal day)');
        ylabel('Fold-change');
        title('Spine density');
        xlim([40 160]); ylim([-0.35 0.05]);
        
        set(gcf,'Position',[40 40 1400 800]);  %laptop
        set(gcf, 'PaperPositionMode', 'auto');
    end
end